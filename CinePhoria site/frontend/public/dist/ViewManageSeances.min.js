"use strict";var C=function(d,e,n,t){function l(i){return i instanceof n?i:new n(function(c){c(i)})}return new(n||(n=Promise))(function(i,c){function o(s){try{u(t.next(s))}catch(p){c(p)}}function m(s){try{u(t.throw(s))}catch(p){c(p)}}function u(s){s.done?i(s.value):l(s.value).then(o,m)}u((t=t.apply(d,e||[])).next())})};import{DataControllerIntranet as f}from"./DataControllerIntranet.js";import{chargerMenu as U}from"./ViewMenu.js";import{chargerCinemaSites as j}from"./ViewFooter.js";import{syncTableColumnWidths as R,imageFilm as T,formatDateJJMM as V,parseLocalDate as K,formatterJJMM as X,formatDateLocalYYYYMMDD as I}from"./Helpers.js";import{SeanceSeule as G}from"./shared-models/SeanceSeule.js";import{seancesseulesDeleteApi as Z}from"./NetworkController.js";import{userDataController as Y}from"./DataControllerUser.js";let q,w,J="",H=[],z="";export function onLoadManageSeances(){return C(this,void 0,void 0,function*(){var d;console.log("=====> chargement onLoadManageSeances"),yield U(),yield j(),yield f.majVersion();let e;Y&&(e=Y.compte(),e&&e.listCinemas&&!e.isAdministrateur&&(H=(d=e.listCinemas)===null||d===void 0?void 0:d.split(",").map(t=>t.trim().replace(/^"|"$/g,"")),z=e.listCinemas)),console.log("List Cinemas autoris\xE9s = ",z,H);const n=document.querySelector(".titre__filter-dropdown-cinema");if(n){const t=n.querySelector(".title__filter-button-drowdown-content");if(t){t.innerHTML="";const l=document.createElement("a");l.href="#",l.dataset.cinema="Tous les complexes",l.textContent="Tous les complexes",t.appendChild(l),H.forEach(i=>{const c=document.createElement("a");c.href="#",c.dataset.cinema=i,c.textContent=i,t.appendChild(c)})}}yield W(),yield ee(),yield A()})}function A(){return C(this,void 0,void 0,function*(){const d=document.getElementById("seances-table-container");if(!d){console.error("Pas de container");return}d.innerHTML="";let e=(yield f.getSeancesDisplayFilter()).filter(t=>H.includes(t.nameCinema));J&&(e=e.filter(t=>t.dateJour?I(new Date(t.dateJour))===J:!1));const n=yield updateTableSeances(e);d.appendChild(n),R(n),q=yield f.getListFilmsAll(),w=(yield f.getSallesByFilter()).filter(t=>H.includes(t.nameCinema))})}function W(){return C(this,void 0,void 0,function*(){function d(i){document.querySelectorAll(".titre__filter-dropdown-complexe").forEach(o=>{o.style.display="block",o.innerHTML=`${i} <span class="chevron">\u25BC</span>`})}const e=document.querySelector(".titre__filter-dropdown-cinema");if(!e)return;const n=e.querySelector(".title__filter-button-drowdown-content");if(!n)return;console.log("Init dropdown Cinema");const t=document.getElementById("titleLeft");t&&(f.filterNameCinema==="all"?t.innerText="Les s\xE9ances de CinePhoria":t.innerText=`Les s\xE9ances de CinePhoria \xE0 ${f.filterNameCinema}`),f.filterNameCinema==="all"?d("Tous les complexes"):d(f.filterNameCinema),n.querySelectorAll("a").forEach(i=>{i.removeEventListener("click",c=>C(this,void 0,void 0,function*(){})),i.addEventListener("click",c=>C(this,void 0,void 0,function*(){var o;c.preventDefault();const m=((o=i.dataset.cinema)===null||o===void 0?void 0:o.trim())||"";m==="Tous les complexes"?f.filterNameCinema="all":f.filterNameCinema=m,w=yield f.getSallesByFilter(),console.log("Choix du filtre Cinema = ",f.filterNameCinema),d(m);const u=document.getElementById("titleLeft");u&&(f.filterNameCinema==="all"?u.innerText="Les s\xE9ances de CinePhoria":u.innerText=`Les s\xE9ances de CinePhoria \xE0 ${m}`),yield A()}))})})}function ee(){return C(this,void 0,void 0,function*(){let d=document.querySelector(".title__filters-films");if(!d)return;let e=document.createElement("input");e.type="date",e.classList.add("filter-jour-input"),d.prepend(e),e.removeEventListener("change",()=>C(this,void 0,void 0,function*(){})),e.addEventListener("change",()=>C(this,void 0,void 0,function*(){J=e.value,yield A()})),yield te()})}function te(){return C(this,void 0,void 0,function*(){const d=document.querySelector(".filter-jour-input");if(!d)return;const e=(yield f.getSeancesDisplayFilter()).map(n=>n.dateJour).filter(Boolean).sort();if(e.length>0){const n=I(new Date(e[0])),t=I(new Date(e[e.length-1]));d.min=n,d.max=t}else d.min="",d.max=""})}export function updateTableSeances(d){return C(this,void 0,void 0,function*(){const e=document.createElement("div");e.classList.add("tab__seances-liste");const n=document.createElement("table");n.classList.add("tab__seances-liste-table");const t=document.createElement("thead"),l=document.createElement("tr");["Date","Salle","H. D\xE9but","H. Fin","Affiche","Titre","Dur\xE9e","Capacit\xE9","Bande","Qualit\xE9","Actions"].forEach(o=>{const m=document.createElement("th");m.textContent=o,l.appendChild(m)}),t.appendChild(l),n.appendChild(t);const c=document.createElement("tbody");return c.classList.add("liste-table__body"),n.appendChild(c),d.forEach(o=>{var m,u;const s=document.createElement("tr"),p=document.createElement("td");p.textContent=X.format(new Date(o.dateJour||"")),s.appendChild(p);const v=document.createElement("td");!f.filterNameCinema||f.filterNameCinema==="all"?v.textContent=o.nameCinema+"-"+o.nameSalle||"":v.textContent=o.nameSalle||"",s.appendChild(v);const x=document.createElement("td");x.textContent=o.hourBeginHHSMM||"",s.appendChild(x);const _=document.createElement("td");_.textContent=o.hourEndHHSMM||"",s.appendChild(_);const S=document.createElement("td"),E=document.createElement("img");E.src=T((m=o.imageFilm128)!==null&&m!==void 0?m:""),E.alt="Affiche",E.classList.add("content-img-td"),S.appendChild(E),s.appendChild(S);const y=document.createElement("td");y.textContent=o.titleFilm||"",s.appendChild(y);const M=document.createElement("td");M.textContent=o.duration||"",s.appendChild(M);const g=document.createElement("td");g.textContent=((u=o.capacity)===null||u===void 0?void 0:u.toString(10))||"",s.appendChild(g);const L=document.createElement("td");L.textContent=o.bo||"",s.appendChild(L);const b=document.createElement("td");b.textContent=o.qualite||"",s.appendChild(b);const h=document.createElement("td"),F=$("edit",s,o);h.appendChild(F),s.appendChild(h),s.dataset.seanceId=o.seanceId,c.appendChild(s)}),e.appendChild(n),e})}function $(d,e,n){const t=document.createElement("div");if(d==="edit"){t.classList.add("table-content-btns");const l=document.createElement("button");l.classList.add("tab__salles-liste-button"),l.textContent="Editer",l.addEventListener("click",()=>C(this,void 0,void 0,function*(){const c=e.querySelectorAll("td"),o=[];c.forEach(m=>{o.push(m.offsetWidth-30)}),yield ne(e,n,o)})),t.appendChild(l);const i=document.createElement("button");i.classList.add("tab__salles-liste-button"),i.textContent="Supprimer",i.addEventListener("click",()=>{ie(e)}),t.appendChild(i)}if(d==="save"){t.classList.add("table-content-btns");const l=document.createElement("button");l.classList.add("tab__salles-liste-button"),l.textContent="Annuler",l.addEventListener("click",()=>{oe(e,n)});const i=document.createElement("button");i.classList.add("tab__salles-liste-button"),i.textContent="Dupliquer",i.addEventListener("click",()=>C(this,void 0,void 0,function*(){yield k(e,n,!0)})),t.appendChild(i);const c=document.createElement("button");c.classList.add("tab__salles-liste-button"),c.textContent="Modifier",c.addEventListener("click",()=>C(this,void 0,void 0,function*(){yield k(e,n)})),t.appendChild(c),t.appendChild(l)}return t}function ne(d,e,n){return C(this,void 0,void 0,function*(){const t=d.querySelectorAll("td");console.log("Date Entr\xE9e = ",e.dateJour);const l=t[0],i=document.createElement("input");i.type="date",i.valueAsDate=new Date(e.dateJour||""),i.style.width=`${n[0]}px`,i.style.boxSizing="border-box",i.style.textAlign="center",l.textContent="",l.appendChild(i);const c=t[1],o=document.createElement("select");w.forEach(a=>{const r=document.createElement("option");r.value=a.nomSalle,r.textContent=a.nomSalle,a.id===e.salleId&&(r.selected=!0),o.appendChild(r)}),o.style.width=`${n[1]}px`,o.style.boxSizing="border-box",o.style.textAlign="center",o.addEventListener("change",()=>{const a=w.find(r=>r.nomSalle===o.value);a&&(t[7].textContent=a.capacite.toString())}),c.textContent="",c.appendChild(o);function m(a,r){const N=[];let B=a*60;const D=r*60;for(;B<=D;){const O=Math.floor(B/60)%24,P=B%60,Q=`${O.toString().padStart(2,"0")}:${P.toString().padStart(2,"0")}`;N.push(Q),B+=5}return N}const u=t[2],s=document.createElement("select");m(10,24).forEach(a=>{const r=document.createElement("option");r.value=a,r.textContent=a,a===e.hourBeginHHSMM&&(r.selected=!0),s.appendChild(r)}),s.style.width=`${n[2]}px`,s.style.boxSizing="border-box",s.style.textAlign="center",u.textContent="",u.appendChild(s);const p=t[3],v=document.createElement("select");m(11,26).forEach(a=>{const r=document.createElement("option");r.value=a,r.textContent=a,a===e.hourEndHHSMM&&(r.selected=!0),v.appendChild(r)}),v.style.width=`${n[3]}px`,v.style.boxSizing="border-box",v.style.textAlign="center",p.textContent="",p.appendChild(v);const x=t[4];x.style.width=`${n[4]}px`,x.style.boxSizing="border-box";const _=t[5],S=document.createElement("select");q.forEach(a=>{const r=document.createElement("option");r.value=a.titre,r.textContent=a.titre,a.id===e.filmId&&(r.selected=!0),S.appendChild(r)}),S.style.width=`${n[5]}px`,S.style.boxSizing="border-box",S.style.textAlign="center";const E=t[6];E.style.width=`${n[6]}px`,E.style.boxSizing="border-box",S.addEventListener("change",()=>{const a=q.find(r=>r.titre===S.value);a&&(t[4].querySelector("img").src=T(a.affiche),t[6].textContent=a.duration)}),_.textContent="",_.appendChild(S);const y=t[7];y.style.width=`${n[7]}px`,y.style.boxSizing="border-box";const M=t[8],g=document.createElement("select");["VF","VOST"].forEach(a=>{const r=document.createElement("option");r.value=a,r.textContent=a,a===e.bo&&(r.selected=!0),g.appendChild(r)}),g.style.width=`${n[8]}px`,g.style.boxSizing="border-box",g.style.textAlign="center",M.textContent="",M.appendChild(g);const L=t[9],b=document.createElement("select");["4DX","3D","4K"].forEach(a=>{const r=document.createElement("option");r.value=a,r.textContent=a,a===e.qualite&&(r.selected=!0),b.appendChild(r)}),b.style.width=`${n[9]}px`,b.style.boxSizing="border-box",b.style.textAlign="center",L.textContent="",L.appendChild(b);const h=t[10];h.textContent="";const F=$("save",d,e);h.appendChild(F),d.appendChild(h)})}function oe(d,e){var n,t;const l=d.querySelectorAll("td");l[0].textContent=V(K(e.dateJour||""))||"",!f.filterNameCinema||f.filterNameCinema==="all"?l[1].textContent=e.nameCinema+"-"+e.nameSalle||"":l[1].textContent=e.nameSalle||"",l[2].textContent=e.hourBeginHHSMM||"",l[3].textContent=e.hourEndHHSMM||"",l[4].querySelector("img").src=T((n=e.imageFilm128)!==null&&n!==void 0?n:""),l[5].textContent=e.titleFilm||"",l[6].textContent=e.duration||"",l[7].textContent=((t=e.capacity)===null||t===void 0?void 0:t.toString(10))||"",l[8].textContent=e.bo||"",l[9].textContent=e.qualite||"";const i=l[10];i.textContent="";const c=$("edit",d,e);i.appendChild(c)}function k(d,e){return C(this,arguments,void 0,function*(n,t,l=!1){var i,c,o,m;const u=n.querySelectorAll("td"),s=n.dataset.seanceId,p=new G({id:s}),v=u[0].querySelector("input");p.dateJour=v?.value||"";const x=u[1].querySelector("select"),_=((i=w.find(h=>h.nomSalle===x?.value))===null||i===void 0?void 0:i.id)||"";p.salleId=_;const S=((c=w.find(h=>h.nomSalle===x?.value))===null||c===void 0?void 0:c.numPMR)||"0";p.numFreePMR=S.toString(10);const E=u[2].querySelector("select"),y=u[3].querySelector("select");p.hourBeginHHSMM=E?.value||"",p.hourEndHHSMM=y?.value||"";const M=u[5].querySelector("select").value,g=((o=q.find(h=>h.titre===M))===null||o===void 0?void 0:o.id)||"";p.filmId=g,p.numFreeSeats=((m=u[7].textContent)===null||m===void 0?void 0:m.trim())||"0";const L=u[8].querySelector("select");p.bo=L?.value||"";const b=u[9].querySelector("select");p.qualite=b?.value||"",p.alertAvailibility="",l&&(p.id=crypto.randomUUID());try{(yield f.createOrUpdateSeance(p)).message==="create"?alert("S\xE9ance dupliqu\xE9e"):alert("S\xE9ance modifi\xE9e"),yield A()}catch(h){alert("Une erreur est survenue : "+h)}})}function ie(d){return C(this,void 0,void 0,function*(){const e=d.dataset.seanceId;try{const n=yield Z(e);alert("Suppression r\xE9ussie :"+n.message),yield A()}catch(n){console.error("Erreur dans la suppression "+n),alert("Suppression impossible : "+n)}})}
