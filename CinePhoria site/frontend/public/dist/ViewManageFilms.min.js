"use strict";var u=function(e,t,i,n){function l(o){return o instanceof i?o:new i(function(r){r(o)})}return new(i||(i=Promise))(function(o,r){function m(s){try{d(n.next(s))}catch(a){r(a)}}function f(s){try{d(n.throw(s))}catch(a){r(a)}}function d(s){s.done?o(s.value):l(s.value).then(m,f)}d((n=n.apply(e,t||[])).next())})};import{dataController as V}from"./DataController.js";import{DataControllerIntranet as N}from"./DataControllerIntranet.js";import{formatDateLocalYYYYMMDD as J,imageFilm as q,dateProchainMercredi as z}from"./Helpers.js";import{Film as K}from"./shared-models/Film.js";import{chargerMenu as Q}from"./ViewMenu.js";import{chargerCinemaSites as X}from"./ViewFooter.js";import{filmsSelectApi as Z,createAfficheApi as T,updateAfficheApi as W}from"./NetworkController.js";let C=!1,S=!1,v=null,g=null,c;export function onLoadManageFilms(){return u(this,void 0,void 0,function*(){console.log("=====> chargement onLoadManageFilms"),yield Q(),yield X(),yield N.majVersion(),yield U(),te(),G(),w(!1)})}function U(){return u(this,void 0,void 0,function*(){const e=document.querySelector(".films__listFilms");if(!e)return;e.innerHTML="";const t=yield N.allFilms();if(t.forEach(i=>{const n=ee(i);e.appendChild(n)}),t.length>0?(c=t[0],j(c)):$(),c){const i=[...e.querySelectorAll(".listFilms__simpleCard")].find(n=>{var l,o;return(l=n.textContent)===null||l===void 0?void 0:l.includes((o=c?.titleFilm)!==null&&o!==void 0?o:"")});i&&i.scrollIntoView({behavior:"smooth",block:"center"})}})}function ee(e){var t,i,n,l;const o=document.createElement("div");o.classList.add("listFilms__simpleCard");const r=document.createElement("img");r.src=q((t=e.imageFilm1024)!==null&&t!==void 0?t:""),r.alt="Affiche",r.classList.add("simpleCard__affiche-img");const m=document.createElement("div");m.classList.add("simpleCard__detail");const f=document.createElement("p");f.classList.add("simpleCard__detail-titre-p"),f.textContent=(i=e.titleFilm)!==null&&i!==void 0?i:"Sans Titre";const d=document.createElement("div");if(d.classList.add("simpleCard__evaluation"),e.isCoupDeCoeur){const E=document.createElement("div");E.classList.add("evaluation__coupdecoeur");const y=document.createElement("p");y.classList.add("evaluation__coupdecoeur-p"),y.textContent="Coup de coeur";const p=document.createElement("img");p.src="assets/heart.svg",p.alt="Coeur",p.classList.add("evaluation__coupdecoeur-img"),E.append(y,p),d.appendChild(E)}const s=document.createElement("div");s.classList.add("evaluation__note");const a=document.createElement("p");a.classList.add("evaluation__note-p"),a.textContent=`Avis : ${(n=e.note)!==null&&n!==void 0?n:0} / 5`,s.appendChild(a),d.appendChild(s);const h=document.createElement("p");return h.classList.add("simpleCard__detail-pitch-p"),h.textContent=(l=e.filmPitch)!==null&&l!==void 0?l:"",m.append(f,d,h),o.append(r,m),o.addEventListener("click",()=>u(this,void 0,void 0,function*(){console.log("filmId selectionne = ",e.id),c=e,j(e)})),e.isActiveForNewSeances?(r.classList.remove("simpleCard__affiche-img--disabled"),o.classList.remove("listFilms__simpleCard--disabled")):(r.classList.add("simpleCard__affiche-img--disabled"),o.classList.add("listFilms__simpleCard--disabled")),o}function $(){document.querySelector(".films__detailFilm")}function G(){const e=document.getElementById("upload128");e&&(e.value=""),e?.removeEventListener("change",i=>u(this,void 0,void 0,function*(){})),e?.addEventListener("change",i=>u(this,void 0,void 0,function*(){var n;const l=(n=e.files)===null||n===void 0?void 0:n[0];if(!l.type.startsWith("image/jpeg")&&!l.type.startsWith("image/png")){alert("Seuls les fichiers JPEG ou PNG sont autoris\xE9s.");return}if(l){v=l;const o=document.getElementById("affiche-small");o&&(o.src=URL.createObjectURL(l))}}));const t=document.getElementById("upload1024");t&&(t.value=""),t?.removeEventListener("change",i=>u(this,void 0,void 0,function*(){})),t?.addEventListener("change",i=>u(this,void 0,void 0,function*(){var n;const l=(n=t.files)===null||n===void 0?void 0:n[0];if(!l.type.startsWith("image/jpeg")&&!l.type.startsWith("image/png")){alert("Seuls les fichiers JPEG ou PNG sont autoris\xE9s.");return}if(l){g=l,console.log("Selected file 1024 =>",l.name);const o=document.getElementById("affiche-large");o&&(o.src=URL.createObjectURL(l))}}))}function te(){const e=document.getElementById("title__right-button-Ajouter"),t=document.getElementById("title__right-button-Modifier"),i=document.getElementById("title__right-button-Annuler");if(!e||!t||!i){console.error("Missing one of the action buttons in .right__actions");return}e.style.display="inline-block",t.style.display="inline-block",i.style.display="none",e.removeEventListener("click",()=>{}),e.addEventListener("click",ie),t.removeEventListener("click",()=>u(this,void 0,void 0,function*(){})),t.addEventListener("click",()=>u(this,void 0,void 0,function*(){return yield ne()})),i.removeEventListener("click",()=>u(this,void 0,void 0,function*(){})),i.addEventListener("click",()=>u(this,void 0,void 0,function*(){return yield oe()}))}function ie(){S=!0,C=!0,v=null,g=null;const e=new K({id:crypto.randomUUID()});c=e,j(e),O(!0),w(!0);const t=document.getElementById("title__right-button-Modifier");t&&(t.textContent="Enregistrer")}function O(e){const t=document.getElementById("title__right-button-Ajouter"),i=document.getElementById("title__right-button-Modifier"),n=document.getElementById("title__right-button-Annuler");!t||!i||!n||(e?(t.style.display="none",n.style.display="inline-block",i.textContent="Enregistrer",R(!0),i.classList.add("inactif"),i.disabled=!0):(t.style.display="inline-block",n.style.display="none",i.textContent="Modifier",R(!1),i.classList.remove("inactif"),i.disabled=!1))}function ne(){return u(this,void 0,void 0,function*(){if(C)yield le();else{C=!0,S=!1,O(!0),w(!0);const e=document.getElementById("title__right-button-Modifier");e&&(e.textContent="Enregistrer")}})}function oe(){return u(this,void 0,void 0,function*(){if(!C)return;C=!1,S=!1,v=null,g=null,O(!1),w(!1);const e=V.selectedFilmUUID;e?yield Z(e).then(t=>j(t)).catch(t=>console.error(t)):$()})}function R(e){["titleFilm","genreArray","duration","linkBO","note","filmDescription","filmAuthor","filmDistribution","filmPitch"].forEach(i=>{const n=document.getElementById(i);(n instanceof HTMLInputElement||n instanceof HTMLDivElement)&&(e?(n.addEventListener("input",_),n.addEventListener("blur",_)):(n.removeEventListener("input",_),n.removeEventListener("blur",_)))})}function le(){return u(this,void 0,void 0,function*(){const e=de();if(e)try{let t="";if(S?(console.log("Film created => id=",e.id),e.dateSortieCinePhoria=J(z()),v&&(e.imageFilm128=e?.id+"128",yield T(e.imageFilm128,v,128,v.type)),g&&(e.imageFilm1024=e?.id+"1024",yield T(e.imageFilm1024,g,1024,g.type)),t="Film cr\xE9\xE9 avec succ\xE8s"):(console.log("Film updated => id=",e.id),v&&(/^\d+-128\.jpg$/.test(e.imageFilm128)?(e.imageFilm128=e?.id+"128",yield T(e.imageFilm128,v,128,v.type)):yield W(e.imageFilm128,v,128,v.type)),g&&(/^\d+-1024\.jpg$/.test(e.imageFilm1024)?(e.imageFilm1024=e?.id+"1024",yield T(e.imageFilm1024,g,1024,g.type)):yield W(e.imageFilm1024,g,1024,g.type)),t="Film mis \xE0 jour avec succ\xE8s"),!(yield N.createOrUpdateFilm(e)))throw new Error("Erreur: dans la cr\xE9ation ou mise \xE0 jour de film");alert(t),yield U()}catch(t){console.error("Erreur save film =>",t),alert("Erreur => "+t)}finally{C=!1,S=!1,v=null,g=null,O(!1),w(!1),c=e,yield U(),G()}})}function de(){var e,t,i,n,l,o,r,m,f;if(c===void 0)return;const d=c;console.log("On sauvegarde = "+d.titleFilm);const s=document.getElementById("titleFilm");s&&(d.titleFilm=((e=s.textContent)===null||e===void 0?void 0:e.trim())||"");const a=document.getElementById("genreArray");a&&(d.genreArray=((t=a.textContent)===null||t===void 0?void 0:t.trim())||"");const h=document.getElementById("filmPitch");h&&(d.filmPitch=((i=h.textContent)===null||i===void 0?void 0:i.trim())||"");const E=document.getElementById("filmAuthor");E&&(d.filmAuthor=((n=E.textContent)===null||n===void 0?void 0:n.trim())||"");const y=document.getElementById("filmDistribution");y&&(d.filmDistribution=((l=y.textContent)===null||l===void 0?void 0:l.trim())||"");const p=document.getElementById("filmDescription");p&&(d.filmDescription=((o=p.textContent)===null||o===void 0?void 0:o.trim())||"");const F=document.getElementById("linkBO");F&&(d.linkBO=((r=F.textContent)===null||r===void 0?void 0:r.trim())||"");const B=document.getElementById("duration");B&&(d.duration=((m=B.textContent)===null||m===void 0?void 0:m.trim())||"");const b=document.getElementById("coupCoeur");b&&(d.isCoupDeCoeur=b.checked);const L=document.getElementById("title__filter-dropdown-button-genre");L&&(d.categorySeeing=((f=L.textContent)===null||f===void 0?void 0:f.replace("\u25BC","").trim())||"TP");const I=document.getElementById("isActiveForNewSeances");return I&&(d.isActiveForNewSeances=I.checked),d}function j(e){var t,i,n,l,o,r,m,f,d,s,a;const h=document.getElementById("affiche-small");h&&(h.src=e.imageFilm128?q(e.imageFilm128):"https://dummyimage.com/128x128/DAA520/000");const E=document.getElementById("affiche-large");E&&(E.src=e.imageFilm1024?q(e.imageFilm1024):"https://dummyimage.com/1024x1024/DAA520/000");const y=document.getElementById("titleFilm");y&&(y.textContent=(t=e.titleFilm)!==null&&t!==void 0?t:"");const p=document.getElementById("genreArray");p&&(p.textContent=(i=e.genreArray)!==null&&i!==void 0?i:"");const F=document.getElementById("filmPitch");F&&(F.textContent=(n=e.filmPitch)!==null&&n!==void 0?n:"");const B=document.getElementById("filmAuthor");B&&(B.textContent=(l=e.filmAuthor)!==null&&l!==void 0?l:"");const b=document.getElementById("filmDistribution");b&&(b.textContent=(o=e.filmDistribution)!==null&&o!==void 0?o:"");const L=document.getElementById("filmDescription");L&&(L.textContent=(r=e.filmDescription)!==null&&r!==void 0?r:"");const I=document.getElementById("linkBO");I&&(I.textContent=(m=e.linkBO)!==null&&m!==void 0?m:"");const H=document.getElementById("duration");H&&(H.textContent=(f=e.duration)!==null&&f!==void 0?f:"");const A=document.getElementById("coupCoeur");A&&(A.checked=(d=e.isCoupDeCoeur)!==null&&d!==void 0?d:!1);const k=document.getElementById("title__filter-dropdown-button-genre"),x=document.querySelector(".title__filter-button-drowdown-content");k&&x?(k.innerHTML=`${(s=e.categorySeeing)!==null&&s!==void 0?s:"TP"}<span class="chevron">\u25BC</span>`,k.addEventListener("click",M=>{M.stopPropagation(),x.classList.toggle("show")}),document.addEventListener("click",()=>{x.classList.remove("show")}),x.querySelectorAll(".categorie-item").forEach(M=>{M.removeEventListener("click",P=>{}),M.addEventListener("click",P=>{if(k.disabled)return;console.log("listener ",P.target.textContent||"TP"),P.preventDefault();const Y=P.target.textContent||"TP";k.innerHTML=`${Y}<span class="chevron">\u25BC</span>`,x.classList.remove("show"),_()})})):console.error("Pas de dropdown");const D=document.getElementById("isActiveForNewSeances");D&&(D.checked=(a=e.isActiveForNewSeances)!==null&&a!==void 0?a:!1),A?.addEventListener("change",_),D?.addEventListener("change",_)}function w(e){["titleFilm","genreArray","filmAuthor","duration","filmPitch","filmDistribution","linkBO","filmDescription"].forEach(l=>{const o=document.getElementById(l);o&&(o.contentEditable=e?"true":"false",o.style.border=e?"1px solid #000":"none",o.style.background=e?"rgba(255, 215, 0, 0.1)":"#FFF")}),document.getElementById("upload128").hidden=!e,document.getElementById("upload1024").hidden=!e,["isActiveForNewSeances","coupCoeur"].forEach(l=>{const o=document.getElementById(l);o&&(o.disabled=!e)});const i=document.getElementById("title__filter-dropdown-button-genre");i&&(e?(i.classList.remove("inactif"),i.disabled=!1):(i.classList.add("inactif"),i.disabled=!0));const n=document.getElementById("title__filter-listcategorie")}function re(){return["titleFilm","genreArray","filmAuthor","duration","filmDistribution","linkBO","filmDescription"].every(t=>{const i=document.getElementById(t);if(i)return i?.innerText.trim().length>0})}function ce(){if(!c)return!1;const e=(l,o)=>{const r=document.getElementById(l);return r?.innerText.trim()!==(o||"")};if(e("titleFilm",c.titleFilm)||e("genreArray",c.genreArray)||e("filmAuthor",c.filmAuthor)||e("duration",c.duration)||e("filmDistribution",c.filmDistribution)||e("linkBO",c.linkBO)||e("filmDescription",c.filmDescription)||e("filmPitch",c.filmPitch))return!0;const t=document.getElementById("title__filter-dropdown-button-genre");if(t?.innerText.trim().split("\u25BC")[0].trim()!==(c.categorySeeing||"TP"))return!0;const i=document.getElementById("coupCoeur");if(i?.checked!==!!c.isCoupDeCoeur)return!0;const n=document.getElementById("isActiveForNewSeances");return n?.checked!==!!c.isActiveForNewSeances}function _(){const e=document.getElementById("title__right-button-Modifier");e&&(e.disabled=!(re()&&ce()),e.classList.toggle("inactif",e.disabled))}
