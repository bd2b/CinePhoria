"use strict";var E=function(n,c,e,l){function o(s){return s instanceof e?s:new e(function(d){d(s)})}return new(e||(e=Promise))(function(s,d){function t(a){try{m(l.next(a))}catch(r){d(r)}}function v(a){try{m(l.throw(a))}catch(r){d(r)}}function m(a){a.done?s(a.value):o(a.value).then(t,v)}m((l=l.apply(n,c||[])).next())})};import{userDataController as S}from"./DataControllerUser.js";import{dataController as B,dataReady as T}from"./DataController.js";import{chargerMenu as P}from"./ViewMenu.js";import{chargerCinemaSites as Q}from"./ViewFooter.js";import{ReservationState as h}from"./shared-models/Reservation.js";import{getReservationForUtilisateur as F,setStateReservationApi as D,setEvaluationReservationApi as V,cancelReserveApi as z,getReservationQRCodeApi as N}from"./NetworkController.js";import{seanceCardView as q}from"./ViewReservation.js";import{updateTableContent as J}from"./ViewReservationPlaces.js";export function onLoadMesReservations(){return E(this,void 0,void 0,function*(){var n,c;console.log("=====> chargement onLoadMesReservations");try{yield T,console.log("Donn\xE9es charg\xE9es, traitement de la page Mes reservations..."),yield P(),yield Q();let e;if(!((n=S.compte())===null||n===void 0)&&n.utilisateurid)e=((c=S.compte())===null||c===void 0?void 0:c.utilisateurid)||"";else{console.error("Pas d'utilisateur connu");return}try{let l=yield F(e);if(l=l.filter(o=>![h.ReserveCanceled,h.ReserveDeleted].includes(o.stateReservation)),console.log(l),l.length===0){const o=document.getElementById("mesreservations-table-container");if(o){o.innerHTML="";const s=document.createElement("p");s.textContent="Vous n'avez pas de reservation active ou historis\xE9e.",o.appendChild(s)}}else{const o=document.getElementById("mesreservations-table-container");if(o){o.innerHTML="";const s=updateTableMesReservations(l);o.appendChild(s)}}}catch(l){console.log("Erreur recup\xE9ration des reservations = ",l)}}catch(e){console.log("Erreur recup\xE9ration des reservations = ",e)}})}export function updateTableMesReservations(n){const c=document.createElement("div");c.classList.add("tab__mesreservations-liste");const e=document.createElement("table");e.classList.add("tab__mesreservations-liste-table");const l=document.createElement("thead"),o=document.createElement("tr");["Date","Film","Complexe","Note","Vos Commentaires","Places","Montant",""].forEach(t=>{const v=document.createElement("th");v.textContent=t,o.appendChild(v)}),l.appendChild(o),e.appendChild(l);const d=document.createElement("tbody");return d.classList.add("liste-table__body"),e.appendChild(d),n.forEach(t=>{var v,m,a;const r=t.seanceId;r?console.log("resaSeanceId =",r):console.error("resa.seanceId est undefined ou null !");let b=B.allSeances.find(i=>i.seanceId===r);if(!b){console.error(`\u274C Pas de s\xE9ance trouv\xE9e pour seanceId = ${r}`);return}const p=document.createElement("tr"),C=document.createElement("td"),g=document.createElement("button");g.classList.add("tab__mesreservations-liste-button"),g.textContent=U(new Date(t.dateJour||"")),g.addEventListener("click",()=>{Y(t,b)}),C.appendChild(g),p.appendChild(C);const _=document.createElement("td");_.textContent=t.titleFilm||"",p.appendChild(_);const u=document.createElement("td");u.textContent=t.nameCinema||"",p.appendChild(u),console.log("-------"+t.dateJour+"-"+b.hourBeginHHSMM);let y=t.stateReservation;if(y===h.ReserveConfirmed){const i=new Date(t.dateJour);if(!i)return;const f=b.hourBeginHHSMM||"00:00",[A,$]=f.split(":").map(Number),H=new Date(i.getFullYear(),i.getMonth(),i.getDate(),A,$);new Date>H&&(y=h.DoneUnevaluated,D(t.reservationId,h.DoneUnevaluated))}if(y===h.ReserveConfirmed){const i=document.createElement("td");i.setAttribute("colspan","2"),i.style.backgroundColor="#fff7dc",i.textContent="Vous pourrez apporter une note et un avis apr\xE8s avoir vu le film",p.appendChild(i)}else if(y===h.DoneUnevaluated){const i=document.createElement("td");i.setAttribute("colspan","2");const f=document.createElement("button");f.textContent="Donnez nous votre avis sur ce film \u270E",f.classList.add("tab__mesreservations-liste-button"),f.addEventListener("click",()=>{I(t)}),i.appendChild(f),p.appendChild(i)}else if(y===h.DoneEvaluated){const i=document.createElement("td");i.textContent=((v=t.note)===null||v===void 0?void 0:v.toString())||"0",i.style.cursor="pointer",i.addEventListener("click",()=>{I(t,!0)}),p.appendChild(i);const f=document.createElement("td");f.textContent=t.evaluation||"",f.style.cursor="pointer",console.log("Eval = "+t.isEvaluationMustBeReview),t.isEvaluationMustBeReview?(f.style.backgroundColor="#f0f0f0",f.title="Votre commentaire sera publi\xE9 apr\xE8s relecture"):f.title="Votre commentaire a \xE9t\xE9 valid\xE9. Vous pouvez le modifier, il sera republi\xE9 apr\xE8s relecture",f.addEventListener("click",()=>{I(t,!0)}),p.appendChild(f)}else{const i=document.createElement("td");i.setAttribute("colspan","2"),i.textContent="",p.appendChild(i)}const x=document.createElement("td");x.textContent=((m=t.totalSeats)===null||m===void 0?void 0:m.toString())||"0",p.appendChild(x);const w=document.createElement("td"),k=((a=t.totalPrice)===null||a===void 0?void 0:a.toFixed(2))||"0.00";w.textContent=`${k} \u20AC`,p.appendChild(w);const M=document.createElement("td"),L=document.createElement("button");L.classList.add("button");let R="";if(y===h.ReserveConfirmed?R="Annuler":[h.DoneEvaluated,h.DoneUnevaluated].includes(y)&&(R="Effacer"),R!==""){if(y===h.ReserveConfirmed){const i=document.createElement("button");i.classList.add("button"),i.textContent="QRCode",i.style.marginRight="5px",i.addEventListener("click",()=>E(this,void 0,void 0,function*(){j(yield N(t.reservationId))})),M.appendChild(i)}L.textContent=R,L.addEventListener("click",()=>{X(t,R)}),M.appendChild(L),p.appendChild(M)}d.appendChild(p)}),c.appendChild(e),c}function U(n){if(!n)return"";const c=String(n.getDate()).padStart(2,"0"),e=String(n.getMonth()+1).padStart(2,"0"),l=n.getFullYear();return`${c}/${e}/${l}`}function Y(n,c){return E(this,void 0,void 0,function*(){let e=c;yield B.updateSeances([e.seanceId]),e=B.seanceById(c.seanceId);const l=`  
        <div class="modal__content-wrapper">
            <div class="modal__title">
                <div class="title__detailReservation title-h2">
                    <h2>D\xE9tail de la r\xE9servation</h2>
                </div>
                <!-- Bouton (X) ou autre m\xE9canisme pour fermer la modale si besoin -->
                <span class="close-modal" id="close-detailReservation">\xD7</span>
            </div>
            <div class="modal__content" id="content__DetailReservation" >
                
            </div>
        </div>`,o=document.getElementById("modal-detailReservation");if(!o)return;o.innerHTML=l,document.body.appendChild(o);const s=document.getElementById("close-detailReservation"),d=document.getElementById("content__DetailReservation");if(o&&s&&d){const t=()=>{o.style.display="none",window.location.reload()};s.addEventListener("click",t),o.addEventListener("click",a=>{a.target===o&&t()});const v=q(e,new Date(n.dateJour||""),"",!1);d.appendChild(v);const m=yield J(e.qualite||"",!0,n.reservationId);if(d.appendChild(m),n.numberPMR&&n.numberPMR>0){const a=document.createElement("p");a.textContent=n.numberPMR+" place"+(n.numberPMR>1?"s P.M.R.":" P.M.R."),d.appendChild(a)}if(n.seatsReserved&&n.seatsReserved!==""){const a=n.seatsReserved.includes(",")?"s":"",r=document.createElement("p");r.textContent=`Si\xE8ge${a} r\xE9serv\xE9${a} : ${n.seatsReserved}`,d.appendChild(r)}o.style.display="flex"}else console.error("Un ou plusieurs \xE9l\xE9ments requis pour le fonctionnement de la modal modal-detailReservation sont introuvables.")})}function I(n,c=!1){const e=document.getElementById("modal-evaluationReservation");let l="Comment avez-vous trouv\xE9 le film ?",o="Votre note : ",s="Choisissez ",d="",t=null;if(c&&(l="Modifiez votre \xE9valuation",o="Changer la note ("+n.note.toString()+") : ",s=n.note.toString(),t=n.note.toString(),d=n.evaluation),!e)return;const v=`
    <div class="modal__content-wrapper">
        <div class="modal__title">
            <div class="title__evaluationReservation title-h2">
                <h2>${l}</h2>
            </div>
            <span class="close-modal" id="close-evaluationReservation">\xD7</span>
        </div>
        <div class="modal__content" id="content__EvaluationReservation">
            <div>
                <label for="eval-note">${o}<span style="color: red;">*</span></label>
                <div class="title__filter-dropdown">
                    <button class="title__filter-dropdown-button" id="eval-note-button">${s}<span class="chevron">\u25BC</span>
                    </button>
                    <div class="title__filter-button-drowdown-content" id="eval-note-dropdown">
                        ${[0,.5,1,1.5,2,2.5,3,3.5,4,4.5,5].map(u=>`<a href="#" data-value="${u}">${u}</a>`).join("")}
                    </div>
                </div>
                <span id="eval-error" style="color: red; font-size: 0.8em; display: none;">Note obligatoire</span>
            </div>
            <label for="eval-text">Commentaire :</label>
            <textarea id="eval-text" rows="4" cols="40">${d}</textarea>
            <div class="modal__btns">
                <button id="evalAnnulerBtn" class="button">Annuler</button>
                <button id="evalEnregistrerBtn" class="button inactif" disabled>Enregistrer</button>
            </div>
        </div>
    </div>`;e.innerHTML=v,document.body.appendChild(e),e.style.display="flex";const m=document.getElementById("close-evaluationReservation"),a=document.getElementById("eval-note-button"),r=document.getElementById("eval-note-dropdown"),b=document.getElementById("eval-text"),p=document.getElementById("eval-error"),C=document.getElementById("evalEnregistrerBtn"),g=document.getElementById("evalAnnulerBtn"),_=()=>{e.style.display="none"};a?.addEventListener("click",u=>{u.stopPropagation(),r.classList.toggle("show")}),c&&(p.style.display="none",C.classList.remove("inactif"),C.disabled=!1),r?.querySelectorAll("a").forEach(u=>{u.addEventListener("click",y=>{y.preventDefault(),t=u.getAttribute("data-value"),a.innerHTML=`${t} <span class="chevron">\u25BC</span>`,r.classList.remove("show"),t&&(p.style.display="none",C.classList.remove("inactif"),C.disabled=!1)})}),document.addEventListener("click",u=>{a.contains(u.target)||r.classList.remove("show")}),m?.addEventListener("click",_),e.addEventListener("click",u=>{u.target===e&&_()}),g?.addEventListener("click",_),C?.addEventListener("click",()=>E(this,void 0,void 0,function*(){if(!t){p.style.display="inline";return}const u=b.value.trim();console.log("Note enregistr\xE9e :",t),console.log("Commentaire :",u),yield V(n.reservationId,parseFloat(t),u,!0),yield D(n.reservationId,h.DoneEvaluated),_(),onLoadMesReservations()}))}function j(n){return E(this,void 0,void 0,function*(){const c=`
    <div class="modal__content-wrapper">
        <div class="modal__title">
            <div class="title__DisplayQRCode title-h2">
                <h2>QRCode \xE0 pr\xE9senter lors de votre venue</h2>
            </div>
            <span class="close-modal" id="close-displayQRCode">\xD7</span>
        </div>
        <div class="modal__content" id="content__DisplayQRCode">
            <div id="qrcode-img">
            </div>
        </div>
    </div>`;let e=document.getElementById("modal-DisplayQRCodeLocal");e||(e=document.createElement("div")),e.classList.add("modal"),e.setAttribute("id","modal-DisplayQRCodeLocal"),e.innerHTML="",e.innerHTML=c,document.body.appendChild(e);const l=document.getElementById("qrcode-img");if(!l)return;l.appendChild(n);const o=()=>{e.style.display="none"},s=document.getElementById("close-displayQRCode");s?.addEventListener("click",o),e.addEventListener("click",d=>{d.target===e&&o()}),e.style.display="flex"})}function X(n,c){return E(this,void 0,void 0,function*(){let e,l="",o="",s="";c==="Annuler"&&(e=()=>E(this,void 0,void 0,function*(){yield z(n.reservationId)}),l="Etes vous s\xFBr de vouloir annuler cette r\xE9servation ?",o="Annulation de la reservation",s="Je confirmer l'annulation"),c==="Effacer"&&(e=()=>E(this,void 0,void 0,function*(){yield D(n.reservationId,h.ReserveDeleted)}),l=`Etes vous s\xFBr de vouloir effacer cette r\xE9servation ? 
        (Nous conserverons la note anonymis\xE9e mais effacerons l'\xE9ventuel commentaire de notre site et les donn\xE9es de la r\xE9servation)`,o="Suppression de la reservation",s="Je confirmer la suppression");const d=document.getElementById("modal-suppressionReservation");if(!d)return;const t=`
    <div class="modal__content-wrapper">
        <div class="modal__title">
            <div class="title__SuppressionReservation title-h2">
                <h2>${o}</h2>
            </div>
            <span class="close-modal" id="close-suppressionReservation">\xD7</span>
        </div>
        <div class="modal__content" id="content__SuppressionReservation">
            <p>${l}</p>
            <div class="modal__btns">
            <button class="button" id="supAnnulerBtn">Annuler</button>
            <button class="button" id="supConfirmerBtn">${s}</button>
            </div>
        </div>
    </div>`;d.innerHTML=t,document.body.appendChild(d),d.style.display="flex";const v=document.getElementById("close-suppressionReservation"),m=document.getElementById("supConfirmerBtn"),a=document.getElementById("supAnnulerBtn"),r=()=>{d.style.display="none"};v?.addEventListener("click",r),d.addEventListener("click",b=>{b.target===d&&r()}),a?.addEventListener("click",r),m&&(m.onclick=()=>E(this,void 0,void 0,function*(){console.log("Suppression demand\xE9e"),yield e(),r(),yield onLoadMesReservations()}))})}
