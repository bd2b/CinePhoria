"use strict";var m=function(t,e,n,i){function c(l){return l instanceof n?l:new n(function(r){r(l)})}return new(n||(n=Promise))(function(l,r){function d(u){try{o(i.next(u))}catch(p){r(p)}}function a(u){try{o(i.throw(u))}catch(p){r(p)}}function o(u){u.done?l(u.value):c(u.value).then(d,a)}o((i=i.apply(t,e||[])).next())})};import{DataControllerIntranet as s}from"./DataControllerIntranet.js";import{chargerMenu as A}from"./ViewMenu.js";import{chargerCinemaSites as S}from"./ViewFooter.js";import{syncTableColumnWidths as L,formatterJJMM as g,formatDateLocalYYYYMMDD as _}from"./Helpers.js";import{ReservationState as w}from"./shared-models/Reservation.js";let E="";export function onLoadManageAvis(){return m(this,arguments,void 0,function*(t="",e="all"){console.log("=====> chargement onLoadManageAvis"),yield s.majVersion(),yield A(),yield S(),yield s.majVersion(),yield M(),yield D(),E=t,s.filterNameCinema=e,yield k()})}function k(){return m(this,void 0,void 0,function*(){const t=document.getElementById("avis-table-container");if(!t){console.error("Pas de container");return}t.innerHTML="";let e=yield s.getReservationForUtilisateurFilter();e=e.filter(c=>c.stateReservation===w.DoneEvaluated&&c.isEvaluationMustBeReview),E&&(e=e.filter(c=>c.dateJour?_(new Date(c.dateJour))===E:!1));const n=yield updateTableAvis(e);t.appendChild(n),L(n);const i=B();t.appendChild(i)})}function M(){return m(this,void 0,void 0,function*(){function t(l){document.querySelectorAll(".titre__filter-dropdown-complexe").forEach(d=>{d.style.display="block",d.innerHTML=`${l} <span class="chevron">\u25BC</span>`})}const e=document.querySelector(".titre__filter-dropdown-cinema");if(!e)return;const n=e.querySelector(".title__filter-button-drowdown-content");if(!n)return;console.log("Init dropdown Cinema");const i=document.getElementById("titleLeft");i&&(s.filterNameCinema==="all"?i.innerText="Mod\xE9rer tous les avis":i.innerText=`Mod\xE9rer les avis pour le cin\xE9ma de ${s.filterNameCinema}`),s.filterNameCinema==="all"?t("Tous les complexes"):t(s.filterNameCinema),n.querySelectorAll("a").forEach(l=>{l.removeEventListener("click",r=>m(this,void 0,void 0,function*(){})),l.addEventListener("click",r=>m(this,void 0,void 0,function*(){var d;r.preventDefault();const a=((d=l.dataset.cinema)===null||d===void 0?void 0:d.trim())||"";a==="Tous les complexes"?s.filterNameCinema="all":s.filterNameCinema=a,console.log("Choix du filtre Cinema = ",s.filterNameCinema),t(a);const o=document.getElementById("titleLeft");o&&(s.filterNameCinema==="all"?o.innerText="Mod\xE9rer tous les avis":o.innerText=`Mod\xE9rer les avis pour le cin\xE9ma de ${a}`),yield k()}))})})}function D(){return m(this,void 0,void 0,function*(){let t=document.querySelector(".title__filters-films");if(!t)return;let e=document.querySelector(".filter-jour-input");e||(e=document.createElement("input"),e.classList.add("filter-jour-input"),e.type="date"),e.value=E,t.prepend(e),e.removeEventListener("change",()=>m(this,void 0,void 0,function*(){})),e.addEventListener("change",()=>m(this,void 0,void 0,function*(){E=e.value,yield k()})),yield q()})}function q(){return m(this,void 0,void 0,function*(){const t=document.querySelector(".filter-jour-input");if(!t)return;const e=(yield s.getReservationForUtilisateurFilter()).map(n=>n.dateJour).filter(Boolean).sort();if(e.length>0){const n=_(new Date(e[0])),i=_(new Date(e[e.length-1]));t.min=n,t.max=i}else t.min="",t.max=""})}export function updateTableAvis(t){return m(this,void 0,void 0,function*(){const e=document.createElement("div");e.classList.add("tab__avis-liste");const n=document.createElement("table");n.classList.add("tab__avis-liste-table"),n.id="tab__avis-liste-table";const i=document.createElement("thead"),c=document.createElement("tr");["Date","Film","Utilisateur","Note","Commentaire","Mod\xE9r\xE9","A Supprimer"].forEach(d=>{const a=document.createElement("th");a.textContent=d,c.appendChild(a)}),i.appendChild(c),n.appendChild(i);const r=document.createElement("tbody");return r.classList.add("liste-table__body"),n.appendChild(r),t.forEach(d=>{var a;const o=document.createElement("tr"),u=document.createElement("td");u.textContent=g.format(new Date(d.dateJour||"")),o.appendChild(u);const p=document.createElement("td");p.textContent=d.titleFilm||"",o.appendChild(p);const C=document.createElement("td");C.textContent=d.displayName||"",o.appendChild(C);const b=document.createElement("td");b.textContent=((a=d.note)===null||a===void 0?void 0:a.toString(10))||"",o.appendChild(b);const x=document.createElement("td");x.textContent=d.evaluation||"",o.appendChild(x);const v=document.createElement("td"),f=document.createElement("input");f.type="checkbox",f.checked=!0,d.isEvaluationMustBeReview&&(f.checked=!1),v.dataset.ischecked=f.checked?"true":"false",v.appendChild(f),o.appendChild(v);const h=document.createElement("td"),y=document.createElement("input");y.type="checkbox",y.checked=!1,h.appendChild(y),o.appendChild(h),o.dataset.reservationId=d.reservationId,r.appendChild(o)}),r.querySelectorAll("tr").forEach(d=>{const a=d.querySelector('td:nth-child(7) input[type="checkbox"]'),o=d.querySelector('td:nth-child(6) input[type="checkbox"]');a.addEventListener("change",()=>{a.checked?o.disabled=!0:o.disabled=!1}),o.addEventListener("change",()=>{o.checked?a.disabled=!0:a.disabled=!1})}),e.appendChild(n),e})}function B(){const t=document.createElement("div");t.classList.add("table-content-btns");const e=document.createElement("button");e.classList.add("tab__salles-liste-button"),e.textContent="Appliquer",e.addEventListener("click",()=>m(this,void 0,void 0,function*(){yield R()})),t.appendChild(e);const n=document.createElement("button");return n.classList.add("tab__salles-liste-button"),n.textContent="Remise \xE0 z\xE9ro",n.addEventListener("click",()=>m(this,void 0,void 0,function*(){yield N()})),t.appendChild(n),t}function R(){return m(this,void 0,void 0,function*(){const t=document.getElementById("tab__avis-liste-table");if(!t)return;const e=t.querySelectorAll("tbody tr"),n=[];let i=0,c=0;e.forEach(l=>{var r,d,a,o;const u=l.dataset.reservationId;if(!u)return;const p=l.querySelector('td:nth-child(6) input[type="checkbox"]'),C=p?.parentElement,b=(r=p?.checked)!==null&&r!==void 0?r:!1,x=C?.dataset.ischecked==="true",v=l.querySelector('td:nth-child(7) input[type="checkbox"]'),f=(d=v?.checked)!==null&&d!==void 0?d:!1,h=l.querySelector("td:nth-child(4)"),y=l.querySelector("td:nth-child(5)");f?(n.push({id:u,evaluation:"Evaluation supprim\xE9e car non conforme aux usages",isEvaluationMustBeReview:!1,note:void 0}),c++):b&&!x&&(n.push({id:u,evaluation:((a=y?.textContent)===null||a===void 0?void 0:a.trim())||"",isEvaluationMustBeReview:!1,note:!((o=h?.textContent)===null||o===void 0)&&o.trim()?parseFloat(h.textContent.trim()):void 0}),i++)});for(const l of n)yield s.updateReservationAvis(l);alert(`${i} validation(s) r\xE9alis\xE9e(s) et ${c} avis supprim\xE9(s)`),onLoadManageAvis(E,s.filterNameCinema)})}function N(){return m(this,void 0,void 0,function*(){const t=document.getElementById("tab__avis-liste-table");if(!t)return;t.querySelectorAll("tbody tr").forEach(n=>{const i=n.querySelector('td:nth-child(6) input[type="checkbox"]'),c=n.querySelector('td:nth-child(7) input[type="checkbox"]'),l=i?.parentElement;c&&(c.checked=!1),i&&l&&(i.checked=l.dataset.ischecked==="true"),c&&(c.disabled=!1),i&&(i.disabled=!1)})})}
