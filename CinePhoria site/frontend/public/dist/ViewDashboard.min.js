"use strict";var y=function(s,n,c,f){function g(r){return r instanceof c?r:new c(function(a){a(r)})}return new(c||(c=Promise))(function(r,a){function D(o){try{u(f.next(o))}catch(d){a(d)}}function m(o){try{u(f.throw(o))}catch(d){a(d)}}function u(o){o.done?r(o.value):g(o.value).then(D,m)}u((f=f.apply(s,n||[])).next())})};import{DataControllerIntranet as v}from"./DataControllerIntranet.js";import{chargerMenu as _}from"./ViewMenu.js";import{chargerCinemaSites as E}from"./ViewFooter.js";import{formatDateLocalYYYYMMDD as L}from"./Helpers.js";let l=new Set;const S=["#4e79a7","#f28e2b","#e15759","#76b7b2","#59a14f","#edc949","#af7aa1","#ff9da7"];export function onLoadDashboard(){return y(this,void 0,void 0,function*(){console.log("=====> chargement onLoadDashboard"),yield _(),yield E(),yield v.majVersion(),yield k()})}function k(){return y(this,void 0,void 0,function*(){let s=null,n=yield v.getReservationStatsAll();console.log(n),n.length&&(console.log("Cl\xE9s du premier objet :",Object.keys(n[0])),console.log("Valeur filmTitre =",n[0].filmTitre)),l.clear(),n.filter(e=>e.filmTitre).forEach(e=>l.add(e.filmTitre));const c=document.getElementById("dashboard__listFilms");c.innerHTML="",Array.from(new Set(n.map(e=>e.filmTitre).filter(e=>!!e))).sort((e,t)=>e.localeCompare(t,"fr")).forEach(e=>{const t=document.createElement("button");t.className="listFilms__simpleCard",t.textContent=e,t.classList.add("selected"),t.removeEventListener("click",()=>{}),t.addEventListener("click",()=>{g(e,t),console.log("clic =",e),console.log(l)}),c.appendChild(t)});function g(e,t){l.has(e)?(l.delete(e),t.classList.remove("selected")):(l.add(e),t.classList.add("selected")),d()}const r=document.querySelector(".graph__date");r&&(r.innerHTML="");let a=document.createElement("input");r.classList.add("filter-jour-input");const D=new Date().toISOString().substring(0,10);a.type="date",a.value=D,a.removeEventListener("change",()=>{}),a.addEventListener("change",()=>{d(),m()}),r.appendChild(a);function m(){const e=n.map(t=>t.jour).filter(Boolean).sort();if(e.length>0){const t=L(new Date(e[0])),b=L(new Date(e[e.length-1]));a.min=t,a.max=b}else a.min="",a.max=""}const u=document.querySelector(".graph__chart");u.innerHTML="";const o=document.createElement("canvas");o.id="reservationChart",u.appendChild(o),s=new Chart(o,{type:"bar",data:{labels:[],datasets:[{label:"R\xE9servations",data:[]}]},options:{maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}});function d(){if(!s)return;const e=new Date(a.value);if(isNaN(e.getTime()))return;const t=[];for(let i=0;i<7;i++){const h=new Date(e);h.setDate(e.getDate()+i),t.push(h.toISOString().substring(0,10))}const T=(l.size?Array.from(l):Array.from(new Set(n.map(i=>i.filmTitre)))).map((i,h)=>{const C=t.map(M=>n.filter(p=>p.filmTitre===i&&new Date(p.jour).toISOString().substring(0,10)===M).reduce((p,Y)=>p+Number(Y.totalPlaces),0));return{label:i,data:C,backgroundColor:S[h%S.length],stack:"total"}});s.data={labels:t.map(i=>w(new Date(i))),datasets:T},s.options.scales.x={stacked:!0},s.options.scales.y={stacked:!0,beginAtZero:!0},s.update()}function w(e){return e.toLocaleDateString("fr-FR",{weekday:"short"})}d(),m()})}
