"use strict";var n=function(m,t,e,i){function s(a){return a instanceof e?a:new e(function(o){o(a)})}return new(e||(e=Promise))(function(a,o){function h(r){try{l(i.next(r))}catch(c){o(c)}}function u(r){try{l(i.throw(r))}catch(c){o(c)}}function l(r){r.done?a(r.value):s(r.value).then(h,u)}l((i=i.apply(m,t||[])).next())})};import{DataController as d}from"./DataController.js";import{ReservationState as f}from"./shared-models/Reservation.js";import{TarifQualite as g}from"./shared-models/Seance.js";import{Seance as v}from"./shared-models/Seance.js";import{Cinema as S}from"./shared-models/Cinema.js";import{getCookie as p,isDifferenceGreaterThanHours as _}from"./Helpers.js";export class DataControllerSauveCharge extends d{set filterNameCinema(t){if(t.trim()==="")throw new Error("Le nom du cin\xE9ma ne peut pas \xEAtre vide.");t.trim()!=="all"?(this._selectedNameCinema=t.trim(),console.log("DataC: Cinema selected = ",t)):console.log("DataC: Cinema selected = ",this._selectedNameCinema),console.log("DataC: Cinema filter = ",t),this._filterNameCinema=t,this.sauverComplet()}sauverEtatGlobal(){return n(this,void 0,void 0,function*(){var t;const e={reservationState:this._reservationState,filterNameCinema:this._filterNameCinema,selectedNameCinema:this._selectedNameCinema,selectedFilmUUID:this._selectedFilmUUID,selectedSeanceDate:((t=this._selectedSeanceDate)===null||t===void 0?void 0:t.toISOString())||null,selectedSeanceUUID:this._selectedSeanceUUID,selectedUtilisateurUUID:this._selectedUtilisateurUUID,selectedUtilisateurMail:this._selectedUtilisateurMail,selectedUtilisateurDisplayName:this._selectedUtilisateurDisplayName,selectedReservationUUID:this._selectedReservationUUID,selectedReservationCinema:this._selectedReservationCinema},i=JSON.stringify(e);console.log(`Taille du snapshotGlobal = ${i.length} caract\xE8res`),localStorage.setItem(DataControllerSauveCharge.KEY_GLOBAL,i)})}sauverTarifs(){return n(this,void 0,void 0,function*(){if(!this._tarifQualite)return;const t=this._tarifQualite,e=JSON.stringify(t);console.log(`Sauvegarde des tarifs => taille = ${e.length}`),localStorage.setItem(DataControllerSauveCharge.KEY_TARIFS,e)})}sauverCinemas(){return n(this,void 0,void 0,function*(){if(!this._Cinemas)return;const t=this._Cinemas,e=JSON.stringify(t);console.log(`Sauvegarde des Cinemas => taille = ${e.length}`),localStorage.setItem(DataControllerSauveCharge.KEY_CINEMAS,e)})}sauverSeancesParCinema(){return n(this,void 0,void 0,function*(){if(!this._allSeances)return;const t=new Map;this._allSeances.forEach(e=>{var i,s;const a=((i=e.nameCinema)===null||i===void 0?void 0:i.trim())||"unknown";t.has(a)||t.set(a,[]),(s=t.get(a))===null||s===void 0||s.push(e)}),t.forEach((e,i)=>{const s=JSON.stringify(e),a=`${DataControllerSauveCharge.KEY_SEANCES}_${i}`;console.log(`Sauvegarde seances pour '${i}' => taille ${s.length} chars`),localStorage.setItem(a,s)})})}sauverComplet(){return n(this,void 0,void 0,function*(){yield this.sauverEtatGlobal(),yield this.sauverTarifs(),yield this.sauverCinemas(),yield this.sauverSeancesParCinema()})}chargerEtatGlobal(){return n(this,void 0,void 0,function*(){const t=localStorage.getItem(DataControllerSauveCharge.KEY_GLOBAL);if(!t){console.warn("Aucune donn\xE9e globale trouv\xE9e");return}try{const e=JSON.parse(t);this._reservationState=e.reservationState||f.PendingChoiceSeance,this._filterNameCinema=e.filterNameCinema||void 0,this._selectedNameCinema=e.selectedNameCinema||void 0,this._selectedFilmUUID=e.selectedFilmUUID||void 0,this._selectedSeanceUUID=e.selectedSeanceUUID||void 0,this._selectedUtilisateurUUID=e.selectedUtilisateurUUID||void 0,this._selectedUtilisateurMail=e.selectedUtilisateurMail||void 0,this._selectedUtilisateurDisplayName=e.selectedUtilisateurDisplayName||void 0,this._selectedReservationUUID=e.selectedReservationUUID||void 0,this._selectedReservationCinema=e.selectedReservationCinema||void 0,e.selectedSeanceDate&&(this._selectedSeanceDate=new Date(e.selectedSeanceDate))}catch(e){console.error("Erreur parsing \xE9tat global",e)}})}chargerTarifs(){return n(this,void 0,void 0,function*(){const t=localStorage.getItem(DataControllerSauveCharge.KEY_TARIFS);if(t)try{const e=JSON.parse(t);Array.isArray(e)&&(this._tarifQualite=e.map(i=>new g(i)))}catch(e){console.error("Erreur parsing tarifs",e)}})}chargerCinemas(){return n(this,void 0,void 0,function*(){const t=localStorage.getItem(DataControllerSauveCharge.KEY_CINEMAS);if(t)try{const e=JSON.parse(t);Array.isArray(e)&&(this._Cinemas=e.map(i=>new S(i)))}catch(e){console.error("Erreur parsing cinemas",e)}})}chargerSeancesPourCinema(t){return n(this,void 0,void 0,function*(){const e=`${DataControllerSauveCharge.KEY_SEANCES}_${t}`,i=localStorage.getItem(e);if(!i)return[];try{const s=JSON.parse(i);if(Array.isArray(s))return s.map(a=>new v(a))}catch(s){console.error("Erreur parsing seances pour",t,s)}return[]})}chargerSeancesTousCinemas(){return n(this,void 0,void 0,function*(){var t;if(!this._Cinemas||this._Cinemas.length===0){console.warn("Aucun cin\xE9ma n\u2019est charg\xE9, impossible de charger les s\xE9ances tous cin\xE9mas.");return}this._allSeances=[];for(const e of this._Cinemas){const i=((t=e.nameCinema)===null||t===void 0?void 0:t.trim())||"unknown",s=yield this.chargerSeancesPourCinema(i);this._allSeances.push(...s)}console.log(`Toutes les s\xE9ances de ${this._Cinemas.length} cin\xE9mas charg\xE9es. Nombre total de s\xE9ances : ${this._allSeances.length}.`)})}chargerComplet(){return n(this,void 0,void 0,function*(){console.log("DataC: ChargerComplet multi storage"),yield this.chargerEtatGlobal(),yield this.chargerTarifs(),yield this.chargerCinemas(),yield this.chargerSeancesTousCinemas()})}init(){return n(this,void 0,void 0,function*(){console.log("DataC: Init"),yield this.chargerComplet();let t=!0;const e=p(d.nomCookieDateAccess);e?_(new Date,new Date(e),d.validiteCache)?console.log("DataC: cookie validite expir\xE9"):(t=!1,console.log("DataC: cookie valide")):console.log("DataC: cookie validite absent"),!this._allSeances.length||t?(console.log("[init] Cache inexistant/vide ou expir\xE9 -> rechargement depuis l\u2019API"),yield this.chargerDepuisAPI()):console.log("[init] Donn\xE9es restaur\xE9es depuis localStorage")})}}DataControllerSauveCharge.KEY_GLOBAL="myAppState",DataControllerSauveCharge.KEY_TARIFS="myAppTarifs",DataControllerSauveCharge.KEY_CINEMAS="myAppCinemas",DataControllerSauveCharge.KEY_SEANCES="myAppSeances";
