"use strict";var n=function(u,t,e,i){function a(s){return s instanceof e?s:new e(function(o){o(s)})}return new(e||(e=Promise))(function(s,o){function h(r){try{l(i.next(r))}catch(c){o(c)}}function m(r){try{l(i.throw(r))}catch(c){o(c)}}function l(r){r.done?s(r.value):a(r.value).then(h,m)}l((i=i.apply(u,t||[])).next())})};import{DataController as d}from"./DataController.js";import{ReservationState as f}from"./shared-models/Reservation.js";import{TarifQualite as v}from"./shared-models/Seance.js";import{Seance as g}from"./shared-models/Seance.js";import{Cinema as S}from"./shared-models/Cinema.js";import{getCookie as p,isDifferenceGreaterThanHours as C}from"./Helpers.js";export class DataControllerSauveCharge extends d{sauverEtatGlobal(){return n(this,void 0,void 0,function*(){var t;const e={reservationState:this._reservationState,filterNameCinema:this._filterNameCinema,selectedNameCinema:this._selectedNameCinema,selectedFilmUUID:this._selectedFilmUUID,selectedSeanceDate:((t=this._selectedSeanceDate)===null||t===void 0?void 0:t.toISOString())||null,selectedSeanceUUID:this._selectedSeanceUUID,selectedUtilisateurUUID:this._selectedUtilisateurUUID,selectedUtilisateurMail:this._selectedUtilisateurMail,selectedUtilisateurDisplayName:this._selectedUtilisateurDisplayName,selectedReservationUUID:this._selectedReservationUUID,selectedReservationCinema:this._selectedReservationCinema},i=JSON.stringify(e);console.log(`DataC: Taille du snapshotGlobal = ${i.length} caract\xE8res`),localStorage.setItem(DataControllerSauveCharge.KEY_GLOBAL,i)})}sauverTarifs(){return n(this,void 0,void 0,function*(){if(!this._tarifQualite)return;const t=this._tarifQualite,e=JSON.stringify(t);console.log(`DataC: Sauvegarde des tarifs => taille = ${e.length}`),localStorage.setItem(DataControllerSauveCharge.KEY_TARIFS,e)})}sauverCinemas(){return n(this,void 0,void 0,function*(){if(!this._Cinemas)return;const t=this._Cinemas,e=JSON.stringify(t);console.log(`DataC: Sauvegarde des Cinemas => taille = ${e.length}`),localStorage.setItem(DataControllerSauveCharge.KEY_CINEMAS,e)})}sauverSeancesParCinema(){return n(this,void 0,void 0,function*(){if(!this._allSeances)return;const t=new Map;this._allSeances.forEach(e=>{var i,a;const s=((i=e.nameCinema)===null||i===void 0?void 0:i.trim())||"unknown";t.has(s)||t.set(s,[]),(a=t.get(s))===null||a===void 0||a.push(e)}),t.forEach((e,i)=>{const a=JSON.stringify(e),s=`${DataControllerSauveCharge.KEY_SEANCES}_${i}`;console.log(`DataC: Sauvegarde seances pour '${i}' => taille ${a.length} chars`),localStorage.setItem(s,a)})})}sauverComplet(){return n(this,void 0,void 0,function*(){yield this.sauverEtatGlobal(),yield this.sauverTarifs(),yield this.sauverCinemas(),yield this.sauverSeancesParCinema()})}chargerEtatGlobal(){return n(this,void 0,void 0,function*(){const t=localStorage.getItem(DataControllerSauveCharge.KEY_GLOBAL);if(!t){console.warn("DataC: Aucune donn\xE9e globale trouv\xE9e");return}try{const e=JSON.parse(t);this._reservationState=e.reservationState||f.PendingChoiceSeance,this._filterNameCinema=e.filterNameCinema||void 0,this._selectedNameCinema=e.selectedNameCinema||void 0,this._selectedFilmUUID=e.selectedFilmUUID||void 0,this._selectedSeanceUUID=e.selectedSeanceUUID||void 0,this._selectedUtilisateurUUID=e.selectedUtilisateurUUID||void 0,this._selectedUtilisateurMail=e.selectedUtilisateurMail||void 0,this._selectedUtilisateurDisplayName=e.selectedUtilisateurDisplayName||void 0,this._selectedReservationUUID=e.selectedReservationUUID||void 0,this._selectedReservationCinema=e.selectedReservationCinema||void 0,e.selectedSeanceDate&&(this._selectedSeanceDate=new Date(e.selectedSeanceDate))}catch(e){console.error("DataC: Erreur parsing \xE9tat global",e)}})}chargerTarifs(){return n(this,void 0,void 0,function*(){const t=localStorage.getItem(DataControllerSauveCharge.KEY_TARIFS);if(t)try{const e=JSON.parse(t);Array.isArray(e)&&(this._tarifQualite=e.map(i=>new v(i)))}catch(e){console.error("DataC: Erreur parsing tarifs",e)}})}chargerCinemas(){return n(this,void 0,void 0,function*(){const t=localStorage.getItem(DataControllerSauveCharge.KEY_CINEMAS);if(t)try{const e=JSON.parse(t);Array.isArray(e)&&(this._Cinemas=e.map(i=>new S(i)))}catch(e){console.error("DataC: Erreur parsing cinemas",e)}})}chargerSeancesPourCinema(t){return n(this,void 0,void 0,function*(){const e=`${DataControllerSauveCharge.KEY_SEANCES}_${t}`,i=localStorage.getItem(e);if(!i)return[];try{const a=JSON.parse(i);if(Array.isArray(a))return a.map(s=>new g(s))}catch(a){console.error("DataC: Erreur parsing seances pour",t,a)}return[]})}chargerSeancesTousCinemas(){return n(this,void 0,void 0,function*(){var t;if(!this._Cinemas||this._Cinemas.length===0){console.warn("DataC: Aucun cin\xE9ma n\u2019est charg\xE9, impossible de charger les s\xE9ances tous cin\xE9mas.");return}this._allSeances=[];for(const e of this._Cinemas){const i=((t=e.nameCinema)===null||t===void 0?void 0:t.trim())||"unknown",a=yield this.chargerSeancesPourCinema(i);this._allSeances.push(...a)}console.log(`DataC: Toutes les s\xE9ances de ${this._Cinemas.length} cin\xE9mas charg\xE9es. Nombre total de s\xE9ances : ${this._allSeances.length}.`)})}chargerComplet(){return n(this,void 0,void 0,function*(){console.log("DataC: ChargerComplet multi storage"),yield this.chargerEtatGlobal(),yield this.chargerTarifs(),yield this.chargerCinemas(),yield this.chargerSeancesTousCinemas()})}init(){return n(this,void 0,void 0,function*(){console.log("DataC: Init"),yield this.chargerComplet();let t=!0;const e=p(d.nomCookieDateAccess);e?C(new Date,new Date(e),d.validiteCache)?console.log("DataC: cookie validite expir\xE9"):(t=!1,console.log("DataC: cookie valide")):console.log("DataC: cookie validite absent"),!this._allSeances.length||t?(console.log("[init] Cache inexistant/vide ou expir\xE9 -> rechargement depuis l\u2019API"),yield this.chargerDepuisAPI()):console.log("[init] Donn\xE9es restaur\xE9es depuis localStorage")})}}DataControllerSauveCharge.KEY_GLOBAL="myAppState",DataControllerSauveCharge.KEY_TARIFS="myAppTarifs",DataControllerSauveCharge.KEY_CINEMAS="myAppCinemas",DataControllerSauveCharge.KEY_SEANCES="myAppSeances";
