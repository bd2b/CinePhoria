"use strict";var C=function(t,i,a,o){function c(n){return n instanceof a?n:new a(function(d){d(n)})}return new(a||(a=Promise))(function(n,d){function s(l){try{m(o.next(l))}catch(r){d(r)}}function u(l){try{m(o.throw(l))}catch(r){d(r)}}function m(l){l.done?n(l.value):c(l.value).then(s,u)}m((o=o.apply(t,i||[])).next())})};import{extraireMoisLettre as R,creerDateLocale as J,ajouterJours as D,dateProchainMardi as $,formatDateJJMM as I,formatDateLocalYYYYMMDD as U,isUUID as P}from"./Helpers.js";import{dataController as e,dataReady as A}from"./DataController.js";import{ReservationState as g}from"./shared-models/Reservation.js";import{updateContentPlace as T}from"./ViewReservationPlaces.js";import{modalConfirmUtilisateur as B,updateDisplayReservation as w}from"./ViewReservationDisplay.js";import{chargerMenu as H}from"./ViewMenu.js";import{chargerCinemaSites as k}from"./ViewFooter.js";import{imageFilm as M}from"./Helpers.js";export function onLoadReservation(){return C(this,void 0,void 0,function*(){if(yield A,console.log("Donn\xE9es charg\xE9es, traitement de la page reservations..."),yield H(),yield k(),e.filterNameCinema==="all"&&(e.filterNameCinema=e.selectedNameCinema),yield updateCinema(),["ReserveCompteToConfirm","ReserveMailToConfirm","ReserveToConfirm"].includes(e.reservationState)&&(!P(e.selectedReservationUUID||"")||!P(e.selectedSeanceUUID||""))&&(e.reservationState=g.PendingChoiceSeance),["PendingChoiceSeance","PendingChoiceSeats","ReserveConfirmed"].includes(e.reservationState)){if(e.selectedFilmUUID===void 0){e.selectedReservationUUID=void 0,["PendingChoiceSeance","ReserveConfirmed"].includes(e.reservationState)&&(e.selectedSeanceUUID=void 0);const a=q(e);if(!a[0].filmId)return;e.selectedFilmUUID=a[0].filmId}yield updateContentPage(e),console.log(`dataController.filteredNameCinema = ${e.filterNameCinema} nombre de s\xE9ances = ${e.allSeances.length}`)}["ReserveCompteToConfirm","ReserveMailToConfirm","ReserveToConfirm"].includes(e.reservationState)&&(e.selectedReservationCinema&&e.filterNameCinema!==e.selectedReservationCinema&&(e.filterNameCinema=e.selectedReservationCinema),yield w(),console.log("Affichage de la reservation \xE0 l'\xE9tat : ",e.reservationState)),document.querySelector("main").style.visibility="visible";const t=document.querySelector(".title__filters");t&&(t.style.visibility="visible");const i=document.getElementById("progressIndicator");i?(i.style.removeProperty("display"),i.style.display="none",i.classList.add("hidden"),console.log("Descativation progress")):console.error("Pas d'indicateur")})}export function updateCinema(){return C(this,void 0,void 0,function*(){const t=document.querySelectorAll(".title__filter-button-drowdown-content-complexe");function i(o){const c=document.querySelectorAll(".titre__filter-dropdown-complexe"),n=["PendingChoiceSeance","PendingChoiceSeats"].includes(e.reservationState);c.forEach(d=>{n?d.style.display="block":d.style.display="none",d.innerHTML=`${o} <span class="chevron">\u25BC</span>`})}i(e.selectedNameCinema);const a=document.getElementById("titleLeft");a&&(e.filterNameCinema==="all"?a.innerText="R\xE9servez au CinePhoria all \xE0 g\xE9rer":a.innerText=`R\xE9servez au CinePhoria de ${e.filterNameCinema}`),t.forEach(o=>{o.querySelectorAll("a").forEach(n=>{n.removeEventListener("click",d=>C(this,void 0,void 0,function*(){})),n.addEventListener("click",d=>C(this,void 0,void 0,function*(){var s;d.preventDefault();const u=(s=n.textContent)===null||s===void 0?void 0:s.trim();if(u){console.log("1 - Nouvelle valeur de cinema = ",u),i(u);const m=document.getElementById("titleLeft");m&&(m.innerText=`R\xE9servez au CinePhoria de ${u}`),e.filterNameCinema=u;const l=q(e);if(!l[0].filmId)return;e.selectedFilmUUID=l[0].filmId,basculerPanelChoix(),e.reservationState=g.PendingChoiceSeance,updateContentPage(e);const r=document.getElementById("modal-cinema");r&&(console.log("2 - Fermeture de la modale "),r.classList.remove("show")),console.log(`3 - Fin du changement de cin\xE9ma : ${u}`)}}))})})})}export function updateContentPage(t){return C(this,void 0,void 0,function*(){console.log("UCP 1 - Update content page");const i=t.selectedFilmUUID;if(!i)return;const a=t.selectedFilm,o=t.premierJour(i),c=t.seancesFilmJour(i,o);console.log("UCP 2 - Film par defaut = ",a.titleFilm," Nombre de s\xE9ances",t.seancesFilmJour(a.id,o).length," Date : ",o),["PendingChoiceSeance","PendingChoiceSeats"].includes(t.reservationState)&&(N(),console.log("UCP 5 - Liste des films affich\xE9s"),afficherDetailsFilm(),console.log("UCP 6 - Detail du film selectionn\xE9 affich\xE9s")),t.reservationState===g.PendingChoiceSeance?(console.log("ETAT : choix de la s\xE9ance"),L(o),console.log("UCP 7 - Lignes de tabulation des jours affich\xE9es"),b(o),console.log(`UCP 8 - S\xE9ances affich\xE9es pour ${a.titleFilm} le ${new Date(c[0].dateJour||"")}`)):(t.reservationState=g.PendingChoiceSeats)?(console.log("ETAT : choix des places"),basculerPanelReserve(),T(),yield t.sauverEtatGlobal()):t.reservationState===g.ReserveCompteToConfirm?(console.log("On doit confirmer le compte"),basculerPanelReserve(),w(),B()):t.reservationState===g.ReserveMailToConfirm?console.log("Abandon \xE0 la v\xE9rification de mail"):t.reservationState===g.ReserveToConfirm&&console.log("Abandon au login")})}function q(t){const i=t.filmsJour();console.log("Debut affichage de la liste : ",i.length),i.length===0&&console.error("filmsDuJour est vide");const a=i.reduce((o,c)=>{const n=o.dateSortieCinePhoria?new Date(o.dateSortieCinePhoria):new Date(0),d=c.dateSortieCinePhoria?new Date(c.dateSortieCinePhoria):new Date(0);return d>n||d.getTime()===n.getTime()&&(c.note||0)>(o.note||0)?c:o},i[0]);return t.seancesFilmJour(a.id)}function N(){const t=document.querySelector(".reservation__listFilms");if(!t)return;const i=e.films,a=e.seancesFutures;console.log("Nombre de films dans la liste : ",i.length," nombre de seances =",a.length),t.innerHTML="",t.style.display="flex",i.forEach(o=>{var c;const n=document.createElement("div");n.classList.add("listFilms__simpleCard");const d=document.createElement("img");d.classList.add("listFilms__simpleCard-img"),o.imageFilm1024?d.src=M(o.imageFilm1024):console.log("Erreur imageFilm"),d.alt=(c=o.titleFilm)!==null&&c!==void 0?c:"Affiche";const s=document.createElement("p");s.classList.add("listFilms__simpleCard-p"),s.textContent=o.titleFilm||"",n.appendChild(d),n.appendChild(s),n.removeEventListener("click",()=>{}),n.addEventListener("click",()=>{const u=t.querySelector(".listFilms__simpleCard.selected");u&&u.classList.remove("selected"),n.classList.add("selected"),e.selectedFilmUUID=o.id,e.reservationState=g.PendingChoiceSeance,updateContentPage(e),basculerPanelChoix()}),o.id===e.selectedFilmUUID&&n.classList.add("selected"),t.appendChild(n)})}export function afficherDetailsFilm(){var t,i,a,o,c,n,d;const s=document.querySelector(".reservation__detailFilm");if(!s)return;const u=e.selectedFilm;if(!u){s.innerHTML="<p>Film introuvable.</p>";return}s.innerHTML=`
    <div class="detailFilm__twocolumns">
      <div class="twocolumns__left">
        <img src="${M((t=u.imageFilm1024)!==null&&t!==void 0?t:"")}" alt="Affiche" class="twocolumns__left-img">
        <button class="twocolumns__left-button-bo" id="openModal">Bande Annonce</button>
        <div class="evaluation__note">
            <p class="evaluation__note-p">Avis : ${u.note} / 5</p>
        </div>
        <div class="evaluation__coupdecoeur"  style="visibility: ${u.isCoupDeCoeur?"visible":"hidden"}">
            <p class="evaluation__coupdecoeur-p">Coup de coeur</p>
            <img src="assets/heart.svg" alt="Coeur" class="evaluation__coupdecoeur-img">
        </div>
                
      </div>
      
      <div class="twocolumns__right">
        <p class="right__title-p">${u.titleFilm}</p>
        <div class="right__caractFilm">
          <p class="caractFilm__genre-p">${(i=u.genreArray)!==null&&i!==void 0?i:""}</p>
          <p class="caractFilm__duree-p">${(a=u.duration)!==null&&a!==void 0?a:""}</p>
          <p class="caractFilm__public-p">${(o=u.categorySeeing)!==null&&o!==void 0?o:""}</p>
        </div>
        <p class="right__description-p">${(c=u.filmDescription)!==null&&c!==void 0?c:""}</p>
        <p class="right__author-p">${(n=u.filmAuthor)!==null&&n!==void 0?n:""}</p>
        <p class="right__distribution">${(d=u.filmDistribution)!==null&&d!==void 0?d:""}</p>
      </div>
    </div>
  `;const m=s.querySelector(".twocolumns__left-button-bo"),l=document.getElementById("videoModal"),r=l?.querySelector(".closeyoutube"),p=document.getElementById("youtubeVideo"),f=`${u.linkBO}?autoplay=1`;if(console.log("URL dynamique = ",f),m&&l&&r&&p&&f){m.addEventListener("click",()=>{l.style.display="flex",p.src=f,console.log("URL utilis\xE9e = ",p.src)});const v=()=>{l.style.display="none",p.src=""};r.addEventListener("click",v),l.addEventListener("click",_=>{_.target===l&&v()})}else console.error("Un ou plusieurs \xE9l\xE9ments requis pour le fonctionnement de la modal sont introuvables.")}function L(t=new Date,i=!0){const a=document.querySelector(".panel__tabs");if(!a||!e.selectedFilmUUID)return;const o=e.selectedFilmUUID;a.innerHTML="";let c=e.premierJour(e.selectedFilmUUID);U(c)<U(new Date)&&(c=new Date);const n=J(t),d=i?$(t):D(n,6);if(e.seancesFilmDureeJour(o,n,6).length===0)return;if(!i&&n.getTime()>c.getTime()){const m=document.createElement("p");m.classList.add("tabs__tab-p","tabs__tab-nav-p","tabs__tab-nav-prec-p"),m.textContent="Avant",m.addEventListener("click",()=>{const l=D(n,-7);l.getTime()<=c.getTime()?(L(c,!0),b(c)):(L(l,!1),b(l))}),a.appendChild(m)}let s=new Date(n.getTime()),u=0;for(;s.getTime()<=d.getTime();){if(s.getTime()>=c.getTime()&&e.seancesFilmJour(e.selectedFilmUUID,s).length>0){u+=1;const m=document.createElement("p");m.classList.add("tabs__tab-p","tabs__tab-day-p"),m.textContent=I(s);const l=new Date(s.getTime());m.addEventListener("click",()=>{b(l)}),a.appendChild(m)}s=D(s,1)}if(e.seancesFilmDureeJour(o,D(d,1),7).length>0){const m=document.createElement("p");m.classList.add("tabs__tab-p","tabs__tab-nav-p","tabs__tab-nav-suiv-p"),m.textContent="Apr\xE8s",m.addEventListener("click",()=>{const l=D(d,1);console.log("Apres = ",l),e.selectedSeanceDate=l,L(l,!1),b(l)}),a.appendChild(m)}}const x=new Date;function b(t){return C(this,void 0,void 0,function*(){var i,a;e.selectedSeanceDate=t,e.selectedSeanceUUID=void 0;const o=document.getElementById("panel__choixseance-button");o&&(o.textContent="Choisissez votre s\xE9ance",o.classList.add("inactif"));const c=document.querySelector(".panel__tabs");c&&c.querySelectorAll(".tabs__tab-day-p").forEach(p=>{p.textContent&&(p.textContent.trim()===I(t).trim()?p.classList.add("selected"):p.classList.remove("selected"))});const n=document.querySelector(".panel__seances");if(!n||(n.innerHTML="",!e.selectedFilmUUID))return;const d=e.selectedFilmUUID;let s=e.seancesFilmJour(e.selectedFilmUUID,t);const u=x.getFullYear()===t.getFullYear()&&x.getMonth()===t.getMonth()&&x.getDate()===t.getDate(),m=new Date;if(s.length===0){const r=e.allSeances.find(_=>_.filmId===d),p=(i=r?.titleFilm)!==null&&i!==void 0?i:"Film inconnu",f=(a=r?.nameCinema)!==null&&a!==void 0?a:"Cin\xE9ma inconnu",v=document.createElement("p");v.textContent=`Pas de s\xE9ance pour ${p} au cin\xE9ma ${f} ce jour.`,n.appendChild(v);return}console.log("Film = ",s[0].titleFilm," / nombre de seances = ",s.length," / date = ",U(t));const l=s.map(r=>r.seanceId);yield e.updateSeances(l),s=e.seancesFilmJour(e.selectedFilmUUID,t),s.forEach(r=>{var p;if(u){const[f,v]=((p=r.hourBeginHHSMM)!==null&&p!==void 0?p:"00:00").split(":").map(Number),_=new Date(t);_.setHours(f-1,v,0,0),r._isPast=m>_}else r._isPast=!1}),s.forEach(r=>{var p;if(parseInt((p=r.numFreeSeats)!==null&&p!==void 0?p:"10",10)>-1){const f=seanceCardView(r,t);f.classList.remove("seances__cardseance-selected"),r._isPast?(f.style.opacity="0.2",f.style.pointerEvents="none",console.log("Dans le pass\xE9")):(console.log("Dans le futur"),f.removeEventListener("click",()=>{}),f.addEventListener("click",()=>{console.log(`S\xE9ance cliqu\xE9e : ${r.seanceId}`);const v=document.querySelector(".panel__seances");v&&v.querySelectorAll(".seances__cardseance-selected").forEach(y=>{console.log("Suppression la class selected "),y.classList.remove("seances__cardseance-selected")}),f.classList.add("seances__cardseance-selected"),e.selectedSeanceUUID=r.seanceId,console.log("SeanceId selectionnee = "+e.selectedSeanceUUID+", seance = "+e.seanceSelected().dateJour+","+e.seanceSelected().hourBeginHHSMM);const _=document.getElementById("panel__choixseance-button");if(_){const h=_.cloneNode(!0);h.classList.remove("inactif"),h.textContent="Je r\xE9serve pour cette s\xE9ance !",_.replaceWith(h),h.addEventListener("click",()=>C(this,void 0,void 0,function*(){_&&(basculerPanelReserve(),e.reservationState=g.PendingChoiceSeats,T(),yield e.sauverEtatGlobal())}))}})),n.appendChild(f)}})})}export function seanceCardView(t,i,a="",o=!0){var c,n,d;const s=document.createElement("div");s.classList.add("seances__cardseance"),s.classList.add("seances__cardseance-selected"),a!==""&&(s.id=a);const u=document.createElement("div");u.classList.add("cardseance__horaire");const m=document.createElement("p");m.classList.add("horaire__hour","horaire__hour-begin-p"),m.textContent=t.hourBeginHHSMM||"";const l=document.createElement("p");l.classList.add("horaire__hour","horaire__hour-end-p"),l.textContent=t.hourEndHHSMM||"",u.appendChild(m),u.appendChild(l);const r=document.createElement("div");r.classList.add("cardseance__datesalle");const p=document.createElement("div");p.classList.add("datesalle__date");const f=document.createElement("p");f.classList.add("date__month-p"),f.textContent=R(i);const v=document.createElement("p");v.classList.add("date__day-p"),v.textContent=String(i.getDate());const _=parseInt((c=t.numFreeSeats)!==null&&c!==void 0?c:"10",10);if(o){const S=document.createElement("div");S.classList.add("cardseance__bandeau"),_===0?(S.textContent="______COMPLET_____",s.appendChild(S),s.style.pointerEvents="none"):_<=10&&(S.textContent=`Plus que ${t.numFreeSeats} places disponibles`,s.appendChild(S))}p.appendChild(f),p.appendChild(v);const h=document.createElement("p");h.classList.add("datesalle__salle-p"),h.textContent=(n=t.nameSalle)!==null&&n!==void 0?n:"Salle ?",r.appendChild(p),r.appendChild(h);const y=document.createElement("div");y.classList.add("cardseance__qualitebo");const F=document.createElement("img");F.classList.add("qualitebo-qualite-img"),F.src=`assets/${t.qualite}.png`;const E=document.createElement("p");return E.classList.add("qualitebo-bo-p"),E.textContent=(d=t.bo)!==null&&d!==void 0?d:"VF",y.appendChild(F),y.appendChild(E),s.appendChild(u),s.appendChild(r),s.appendChild(y),s}export function basculerPanelReserve(){const t=document.querySelector(".panel__choix"),i=document.querySelector(".panel__reserve");t&&i&&(t.style.display="none",i.style.display="flex")}export function basculerPanelChoix(){const t=document.querySelector(".panel__choix"),i=document.querySelector(".panel__reserve");t&&i&&(t.style.display="block",i.style.display="none")}
