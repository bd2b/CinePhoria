"use strict";var m=this&&this.__awaiter||function(n,t,e,a){function o(i){return i instanceof e?i:new e(function(s){s(i)})}return new(e||(e=Promise))(function(i,s){function l(c){try{r(a.next(c))}catch(b){s(b)}}function d(c){try{r(a.throw(c))}catch(b){s(b)}}function r(c){c.done?i(c.value):o(c.value).then(l,d)}r((a=a.apply(n,t||[])).next())})};import{Seance as C}from"../shared-models/Seance.js";import{JSDOM as y}from"jsdom";const f=jest.fn().mockResolvedValue(void 0),R=jest.fn().mockResolvedValue(void 0),u=jest.fn().mockResolvedValue({message:"OK"}),p="2029-05-10",x=jest.fn().mockResolvedValue(Object.assign(document.createElement("img"),{alt:"QR Code",src:"data:image/png;base64,FAKE_QR_CODE"}));jest.mock("../DataControllerUser",()=>({userDataController:{compte:jest.fn().mockReturnValue({utilisateurid:"aaaaa-aaaa-aa"}),profil:jest.fn().mockResolvedValue({})}})),jest.mock("../NetworkController",()=>Object.assign(Object.assign({},jest.requireActual("../NetworkController")),{reservationAvisUpdateApi:u,cancelReserveApi:f,setStateReservationApi:R,getReservationQRCodeApi:x})),jest.mock("../DataController",()=>({dataController:{allSeances:[{seanceId:"s1",hourBeginHHSMM:"18:00"}],updateSeances:jest.fn().mockResolvedValue(void 0),seanceById:jest.fn().mockReturnValue({seanceId:"s1",hourBeginHHSMM:"18:00"})},dataReady:Promise.resolve()}));import{updateTableMesReservations as v}from"../ViewMesReservations.js";describe("updateTableMesReservations",()=>{beforeEach(()=>{const n=new y("<!DOCTYPE html><body></body>");global.document=n.window.document,global.window=n.window;const t=new C({seanceId:"s1",hourBeginHHSMM:"18:00"})}),it("g\xE9n\xE8re une table HTML avec une r\xE9servation",()=>{const t=v([{utilisateurId:"aaaaa-aaaa-aa",reservationId:"res1",seanceId:"s1",dateJour:p,titleFilm:"Film Test",nameCinema:"Cin\xE9ma Test",stateReservation:"DoneEvaluated",note:4,evaluation:"Excellent !",totalSeats:2,totalPrice:12.5,isEvaluationMustBeReview:!1}]),e=t.querySelectorAll("tbody tr");expect(e.length).toBe(1),expect(t.textContent).toContain("Film Test"),expect(t.textContent).toContain("Cin\xE9ma Test"),expect(t.textContent).toContain("4"),expect(t.textContent).toContain("Excellent")}),it("affiche le bouton pour d\xE9poser un avis si la r\xE9servation est pass\xE9e et non \xE9valu\xE9e",()=>{const e=v([{utilisateurId:"aaaaa-aaaa-aa",reservationId:"res2",seanceId:"s1",dateJour:"2023-05-10",titleFilm:"Film Test",nameCinema:"Cin\xE9ma Test",stateReservation:"DoneUnevaluated",totalSeats:1,totalPrice:8}]);document.body.appendChild(e);const a=[...e.querySelectorAll("button")].find(o=>o.textContent==="Donnez nous votre avis sur ce film \u270E");expect(a).toBeTruthy()}),it("permet de d\xE9poser un avis et appelle l'API de sauvegarde",()=>m(void 0,void 0,void 0,function*(){const n={utilisateurId:"aaaaa-aaaa-aa",reservationId:"resAvis",seanceId:"s1",dateJour:"2023-05-10",titleFilm:"Film Test",nameCinema:"Cin\xE9ma Test",stateReservation:"DoneUnevaluated",totalSeats:1,totalPrice:8};document.body.innerHTML=`
            <div id="modal-EvaluationReservation" class="modal" style="display: none;">
                <div class="modal__content-wrapper">
                    <div class="modal__title">
                        <div class="title__evaluationReservation title-h2">
                            <h2>Comment avez-vous trouv\xE9 le film ?</h2>
                        </div>
                        <span class="close-modal" id="close-evaluationReservation">\xD7</span>
                    </div>
                    <div class="modal__content" id="content__EvaluationReservation">
                        <div>
                            <label for="eval-note">Votre note :</label>
                            <div class="title__filter-dropdown">
                                <button class="title__filter-dropdown-button" id="eval-note-button">Choisissez <span class="chevron">\u25BC</span></button>
                                <div class="title__filter-button-drowdown-content" id="eval-note-dropdown" style="display: block;">
                                    <a href="#" data-value="4">4</a>
                                </div>
                            </div>
                        </div>
                        <label for="eval-text">Commentaire :</label>
                        <textarea id="eval-text" rows="4" cols="40"></textarea>
                        <div class="modal__btns">
                            <button id="evalAnnulerBtn" class="button">Annuler</button>
                            <button id="evalEnregistrerBtn" class="button" disabled>Enregistrer</button>
                        </div>
                    </div>
                </div>
            </div>
        `;const t=v([n]);document.body.appendChild(t);const e=[...t.querySelectorAll("button")].find(s=>{var l;return(l=s.textContent)===null||l===void 0?void 0:l.includes("Donnez nous votre avis")});expect(e).toBeTruthy(),e?.click(),yield new Promise(s=>setTimeout(s,100));const a=document.querySelector('#eval-note-dropdown a[data-value="4"]');expect(a).toBeTruthy(),a.click();const o=document.getElementById("eval-text");o.value="Ceci est un avis";const i=document.getElementById("evalEnregistrerBtn");i.addEventListener("click",()=>{u("resAvis",{note:4,evaluation:"Ceci est un avis"})}),i.disabled=!1,i.classList.remove("inactif"),i.click(),yield new Promise(s=>setTimeout(s,100)),console.log("Appels API :",u.mock.calls),expect(u).toHaveBeenCalledWith("resAvis",expect.objectContaining({note:4,evaluation:"Ceci est un avis"}))})),it("permet de modifier un avis existant pour une r\xE9servation \xE9valu\xE9e et appelle l'API",()=>m(void 0,void 0,void 0,function*(){var n;const t={utilisateurId:"aaaaa-aaaa-aa",reservationId:"res3",seanceId:"s1",dateJour:"2023-05-10",titleFilm:"Film Test",nameCinema:"Cin\xE9ma Test",stateReservation:"DoneEvaluated",note:3,evaluation:"Pas mal",totalSeats:1,totalPrice:10};document.body.innerHTML=`
            <div id="modal-EvaluationReservation" class="modal" style="display: none;">
                <div class="modal__content-wrapper">
                    <div class="modal__title">
                        <div class="title__evaluationReservation title-h2">
                            <h2>Comment avez-vous trouv\xE9 le film ?</h2>
                        </div>
                        <span class="close-modal" id="close-evaluationReservation">\xD7</span>
                    </div>
                    <div class="modal__content" id="content__EvaluationReservation">
                        <div>
                            <label for="eval-note">Votre note :</label>
                            <div class="title__filter-dropdown">
                                <button class="title__filter-dropdown-button" id="eval-note-button">Choisissez <span class="chevron">\u25BC</span></button>
                                <div class="title__filter-button-drowdown-content" id="eval-note-dropdown" style="display: block;">
                                    <a href="#" data-value="5">5</a>
                                </div>
                            </div>
                        </div>
                        <label for="eval-text">Commentaire :</label>
                        <textarea id="eval-text" rows="4" cols="40"></textarea>
                        <div class="modal__btns">
                            <button id="evalAnnulerBtn" class="button">Annuler</button>
                            <button id="evalEnregistrerBtn" class="button" disabled>Enregistrer</button>
                        </div>
                    </div>
                </div>
            </div>
        `;const e=v([t]);document.body.appendChild(e);const a=document.createElement("button");a.textContent="Modifier votre avis",(n=e.querySelector("td"))===null||n===void 0||n.appendChild(a);const o=[...e.querySelectorAll("button")].find(d=>{var r;return(r=d.textContent)===null||r===void 0?void 0:r.includes("Modifier votre avis")});expect(o).toBeTruthy(),o?.click(),yield new Promise(d=>setTimeout(d,100)),document.querySelector('#eval-note-dropdown a[data-value="5"]').click();const s=document.getElementById("eval-text");s.value="Finalement excellent";const l=document.getElementById("evalEnregistrerBtn");l.addEventListener("click",()=>{u("res3",{note:5,evaluation:"Finalement excellent"})}),l.disabled=!1,l.classList.remove("inactif"),l.click(),yield new Promise(d=>setTimeout(d,100)),expect(u).toHaveBeenCalledWith("res3",expect.objectContaining({note:5,evaluation:"Finalement excellent"}))}))}),describe("interaction : click sur bouton date",()=>{beforeEach(()=>{document.body.innerHTML=`
        <div id="modal-detailReservation"></div>
      `}),it("ouvre la modale avec la r\xE9servation",()=>m(void 0,void 0,void 0,function*(){const t=v([{utilisateurId:"aaaaa-aaaa-aa",reservationId:"res1",seanceId:"s1",dateJour:p,titleFilm:"Film Test",nameCinema:"Cin\xE9ma Test",stateReservation:"DoneEvaluated",note:4,evaluation:"Super",totalSeats:2,totalPrice:12.5,isEvaluationMustBeReview:!1}]);document.body.appendChild(t);const e=t.querySelector("button.tab__mesreservations-liste-button");expect(e).toBeTruthy(),e?.click(),yield new Promise(o=>setTimeout(o,100));const a=document.getElementById("modal-detailReservation");expect(a.style.display).toBe("flex"),expect(a.textContent).toContain("D\xE9tail de la r\xE9servation"),expect(a.textContent).toContain("18:00")}))}),describe("interaction : click sur bouton QRCode",()=>{beforeEach(()=>{document.body.innerHTML=`
        <div id="modal-DisplayQRCodeLocal" class="modal"></div>
        <div id="modal-detailReservation"></div>
      `,localStorage.setItem("jwtAccessToken","fake-token")}),it("affiche une modale contenant un QRCode et un titre",()=>m(void 0,void 0,void 0,function*(){const t=v([{utilisateurId:"aaaaa-aaaa-aa",reservationId:"res1",seanceId:"s1",dateJour:p,titleFilm:"Film Test",nameCinema:"Cin\xE9ma Test",stateReservation:"ReserveConfirmed",totalSeats:2,totalPrice:12.5}]);document.body.appendChild(t);const e=[...t.querySelectorAll("button")].find(i=>i.textContent==="QRCode");expect(e).toBeTruthy(),e?.click(),yield new Promise(i=>setTimeout(i,100));const a=document.getElementById("modal-DisplayQRCodeLocal");expect(a.style.display).toBe("flex"),expect(a.textContent).toContain("QRCode \xE0 pr\xE9senter lors de votre venue");const o=a.querySelector("img");expect(o).toBeTruthy(),expect(o?.src).toContain("data:image/png")}))}),describe("interaction : bouton Annuler",()=>{beforeEach(()=>{document.body.innerHTML='<div id="modal-suppressionReservation" class="modal"></div>'}),it('affiche la modale de confirmation et appelle l"API de suppression',()=>m(void 0,void 0,void 0,function*(){const t=v([{utilisateurId:"aaaaa-aaaa-aa",reservationId:"res1",seanceId:"s1",dateJour:p,titleFilm:"Film Test",nameCinema:"Cin\xE9ma Test",stateReservation:"ReserveConfirmed",totalSeats:2,totalPrice:12.5}]);document.body.appendChild(t);const e=[...t.querySelectorAll("button")].find(o=>o.textContent==="Annuler");expect(e).toBeTruthy(),e?.click(),yield new Promise(o=>setTimeout(o,50));const a=document.getElementById("supConfirmerBtn");expect(a).toBeTruthy(),a.click(),yield new Promise(o=>setTimeout(o,50)),expect(f).toHaveBeenCalledWith("res1")}))});
