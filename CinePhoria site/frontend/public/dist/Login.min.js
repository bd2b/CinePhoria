"use strict";var u=function(c,f,o,t){function m(e){return e instanceof o?e:new o(function(i){i(e)})}return new(o||(o=Promise))(function(e,i){function s(n){try{r(t.next(n))}catch(v){i(v)}}function a(n){try{r(t.throw(n))}catch(v){i(v)}}function r(n){n.done?e(n.value):m(n.value).then(s,a)}r((t=t.apply(c,f||[])).next())})};import{validateEmail as h}from"./Helpers.js";import{showCustomAlert as w}from"./Helpers.js";import{dataController as L}from"./DataController.js";import{userDataController as y}from"./DataControllerUser.js";import{loginApi as _,askResetPwdApi as B,resetPwdApi as I}from"./NetworkController.js";import{confirmReserve as P}from"./ViewReservationPlaces.js";import{ReservationState as C}from"./shared-models/Reservation.js";const k=`
  <!-- Modale loginWithEmail -->  
  <div id="modal-loginEmail" class="modal">
    <div class="modal__content-wrapper">
      <div class="modal__title">
        <div class="title__loginEmail title-h2">
          <h2>Connexion</h2>
        </div>
        <span class="close-modal" id="close-loginEmail">\xD7</span>
      </div>
      <div class="modal__content">
        <div class="title-p" id="invite-p">
            <p>Veuillez vous connecter pour valider la r\xE9servation.</p>
        </div>
        <div class="form__group">
            <label for="loginEmail-email">Email :</label>
            <input type="email" id="loginEmail-email" class="input__mail" disabled />
            <span id="email-error" class="error-message"></span>
        </div>
        <div class="form__group">
            <label for="loginEmail-password">Mot de passe :</label>
            <input type="password" id="loginEmail-password" />
        </div>
        <span id="login-error" class="error-message" hidden="true">-</span>
  
        <div class="form__group" style="margin-top: 15px; display: flex; flex-direction: row; gap: 10px;">
            <button id="loginCreateAccount" class="button button-secondary">Cr\xE9er votre compte</button>
            <button id="loginForgotPassword" class="button button-secondary">Mot de passe oubli\xE9</button>
            <button id="loginCloseModal" class="button">Fermer</button>
            <button id="loginEmail-submit" class="button button-primary inactif" disabled>Valider</button>
        </div>
      </div>
    </div>
  </div>
  `;export function login(){return u(this,arguments,void 0,function*(c="Veuillez vous connecter...",f=!1){let o=document.getElementById("modal-loginEmail");if(!o){const l=document.createElement("div");l.innerHTML=k,document.body.appendChild(l),o=document.getElementById("modal-loginEmail")}if(!o){console.error("Impossible de cr\xE9er / trouver #modal-loginEmail");return}o.style.display="flex";const t=()=>{o.style.display="none"},m=document.getElementById("close-loginEmail"),e=document.getElementById("loginEmail-submit"),i=document.getElementById("loginCreateAccount"),s=document.getElementById("loginForgotPassword"),a=document.getElementById("loginCloseModal");m?.addEventListener("click",t),o.addEventListener("click",l=>{l.target===o&&t()}),a&&a.addEventListener("click",t),i&&(i.removeEventListener("click",l=>u(this,void 0,void 0,function*(){})),i.addEventListener("click",l=>u(this,void 0,void 0,function*(){l.preventDefault(),l.stopPropagation(),alert("La cr\xE9ation de compte sera r\xE9alis\xE9e lors de votre premi\xE8re r\xE9servation.")}))),s&&(s.removeEventListener("click",l=>u(this,void 0,void 0,function*(){})),s.addEventListener("click",l=>u(this,void 0,void 0,function*(){l.preventDefault(),l.stopPropagation();const d=document.getElementById("loginEmail-email");if(!d||!h(d.value.trim())){alert("Email invalide (exemple: utilisateur@domaine.com)");return}x(d.value.trim()),t()})));const r=document.getElementById("invite-p"),n=document.getElementById("loginEmail-email"),v=document.getElementById("loginEmail-password"),g=document.getElementById("email-error"),p=document.getElementById("login-error");r?r.innerHTML="<p>"+c+"</p>":console.log("Pas d'invite dans la modale"),n.disabled=!f;function E(){return n.value.trim()!==""&&v.value.trim()!==""}function b(){const l=h(n.value),d=E();s&&i&&(l?(s.classList.remove("inactif"),s.disabled=!1,i.classList.add("inactif"),i.disabled=!0):(s.classList.add("inactif"),s.disabled=!0,i.classList.remove("inactif"),i.disabled=!1)),l&&d?(e.classList.remove("inactif"),e.disabled=!1,p.hidden=!0):(e.classList.add("inactif"),e.disabled=!0)}f||(n.value=L.selectedUtilisateurMail||""),e.classList.add("inactif"),g.textContent="",n.addEventListener("blur",()=>{h(n.value)?g.textContent="":(g.textContent="Email invalide (exemple: utilisateur@domaine.com)",g.style.color="red")}),n.addEventListener("input",b),v.addEventListener("input",b),e&&(e.removeEventListener("click",l=>u(this,void 0,void 0,function*(){})),e.addEventListener("click",l=>u(this,void 0,void 0,function*(){if(l.preventDefault(),l.stopPropagation(),L.reservationState===C.ReserveToConfirm)try{yield _(n.value.trim(),v.value.trim()),console.log("Connexion workflow reservation r\xE9ussie"),o&&(o.style.display="none"),y.ident=n.value.trim(),yield y.init(),yield P();const d=y.profil();window.location.href=d}catch(d){console.log(d),p.hidden=!1,p.textContent=d,p.style.color="red"}else try{yield _(n.value.trim(),v.value.trim()),console.log("Connexion simple r\xE9ussie"),o&&(o.style.display="none"),console.log("email logu\xE9 = ",n.value.trim()),y.ident=n.value.trim(),console.log("ident stock\xE9e = ",y.ident),yield y.init(),console.log("Compte charge = ",y.compte());const d=y.profil();console.log("Page redirig\xE9e",d),window.location.href=d}catch(d){console.log(d),p.hidden=!1,p.textContent=d,p.style.color="red"}}))),b()})}function x(c){const f=`
    <div id="modal-reinitPass" class="modal">
        <div class="modal__content-wrapper">
            <div class="modal__title">
                <h2>R\xE9initialisation de votre mot de passe</h2>
                <span class="close-modal" id="close-reinitPass">\xD7</span>
            </div>
            <div class="modal__content">
                <p>Si l'email que vous avez fourni (${c}) est valide, vous allez recevoir un code pour changer votre mot de passe.</p>
                <button id="reinit-continue" class="button button-primary">Continuer</button>
            </div>
        </div>
    </div>
    `,o=document.createElement("div");o.innerHTML=f,document.body.appendChild(o);const t=document.getElementById("modal-reinitPass");t&&(t.style.display="flex");const m=document.getElementById("close-reinitPass"),e=document.getElementById("reinit-continue"),i=()=>{t&&(t.style.display="none")};m?.addEventListener("click",i),t?.addEventListener("click",s=>{s.target===t&&i()}),e?.removeEventListener("click",()=>u(this,void 0,void 0,function*(){})),e?.addEventListener("click",()=>u(this,void 0,void 0,function*(){B(c),i(),M(c)}))}function M(c){const f=`
    <div id="modal-newPass" class="modal">
        <div class="modal__content-wrapper">
            <div class="modal__title">
                <h2>Changer votre mot de passe</h2>
                <span class="close-modal" id="close-newPass">\xD7</span>
            </div>
            <div class="modal__content">
                <p>Veuillez renseigner le code re\xE7u par email, ainsi que votre nouveau mot de passe.</p>
                <div class="form__group">
                    <label for="newPass-code">Code \xE0 6 chiffres :</label>
                    <input type="text" id="newPass-code" placeholder="123456" />
                </div>
                <div class="form__group">
                    <label for="newPass-p1">Nouveau mot de passe :</label>
                    <input type="password" id="newPass-p1" />
                </div>
                <div class="form__group">
                    <label for="newPass-p2">Confirmez le mot de passe :</label>
                    <input type="password" id="newPass-p2" />
                </div>
                <small>8 caract\xE8res minimum, incluant majuscules, minuscules, un caract\xE8re sp\xE9cial et un chiffre.</small>
                <div class="form__group" style="margin-top:10px; display:flex; gap:10px;">
                    <button id="btnResendCode" class="button">Renvoyer un code</button>
                    <button id="btnValidateNewPass" class="button inactif" disabled>Valider</button>
                </div>
            </div>
        </div>
    </div>
    `,o=document.createElement("div");o.innerHTML=f,document.body.appendChild(o);const t=document.getElementById("modal-newPass");t&&(t.style.display="flex");const m=document.getElementById("close-newPass"),e=document.getElementById("newPass-code"),i=document.getElementById("newPass-p1"),s=document.getElementById("newPass-p2"),a=document.getElementById("btnResendCode"),r=document.getElementById("btnValidateNewPass"),n=()=>{t&&(t.style.display="none")};m?.addEventListener("click",n),t?.addEventListener("click",g=>{g.target===t&&n()});function v(){if(!e||!i||!s||!r)return;const g=e.value.trim(),p=i.value.trim(),E=s.value.trim(),b=/^[0-9]{6}$/.test(g),l=/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9]).{8,}$/.test(p);b&&l&&p===E?(r.disabled=!1,r.classList.remove("inactif")):(r.disabled=!0,r.classList.add("inactif"))}e?.addEventListener("input",v),i?.addEventListener("input",v),s?.addEventListener("input",v),a.disabled=!1,a.classList.remove("inactif"),a?.removeEventListener("click",()=>u(this,void 0,void 0,function*(){})),a?.addEventListener("click",()=>u(this,void 0,void 0,function*(){B(c),yield w("Nous vous avons renvoy\xE9 un code."),a.disabled=!0,a.classList.add("inactif")})),r?.addEventListener("click",()=>u(this,void 0,void 0,function*(){if(!e||!i)return;const g=e.value.trim(),p=i.value.trim(),E=yield A(c,g,p);E==="OK"?(yield w("Changement de mot de passe r\xE9ussi, vous pouvez vous connecter."),n(),window.location.reload()):yield w("Erreur : "+E+` 
Recommencez`)}))}function A(c,f,o){return u(this,void 0,void 0,function*(){return yield I(c,f,o),"OK"})}export function logout(){return u(this,void 0,void 0,function*(){try{localStorage.removeItem("jwtAccessToken"),y.invalidate(),window.location.href="visiteur.html"}catch(c){console.error(c)}})}
