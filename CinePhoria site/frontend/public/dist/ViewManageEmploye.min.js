"use strict";var u=function(e,t,i,n){function o(l){return l instanceof i?l:new i(function(r){r(l)})}return new(i||(i=Promise))(function(l,r){function c(s){try{d(n.next(s))}catch(E){r(E)}}function m(s){try{d(n.throw(s))}catch(E){r(E)}}function d(s){s.done?l(s.value):o(s.value).then(c,m)}d((n=n.apply(e,t||[])).next())})};import{DataControllerIntranet as C}from"./DataControllerIntranet.js";import{ComptePersonne as M}from"./shared-models/Utilisateur.js";import{chargerMenu as N}from"./ViewMenu.js";import{chargerCinemaSites as S}from"./ViewFooter.js";import{listCinemasConst as y,validateEmail as F,isPasswordValid as q}from"./Helpers.js";let v=!1,f=!1,a,g=[],V="",T="",P=0;export function onLoadManageEmployes(){return u(this,void 0,void 0,function*(){console.log("=====> chargement onLoadManageEmployes"),yield N(),yield S(),yield C.majVersion(),yield I(),D(),h(!1),document.querySelector("main").style.visibility="visible"})}function I(){return u(this,void 0,void 0,function*(){const e=document.querySelector(".employes__listEmployes");if(e&&(e.innerHTML="",g=yield C.getListEmployesAll(),P=g.reduce((t,i)=>{var n;return Math.max(t,(n=i.matricule)!==null&&n!==void 0?n:0)},0),g.forEach(t=>{const i=j(t);e.appendChild(i)}),g.length>0?(a=g[0],B(a)):x(),a)){const t=[...e.querySelectorAll(".listEmployes__simpleCard")].find(i=>{var n,o;return(n=i.textContent)===null||n===void 0?void 0:n.includes(((o=a.matricule)===null||o===void 0?void 0:o.toString(10))||"")});t&&t.scrollIntoView({behavior:"smooth",block:"center"})}})}function j(e){var t;const i=document.createElement("div");i.classList.add("listEmployes__simpleCard");const n=document.createElement("p");n.classList.add("simpleCard__detail-titre-p"),n.textContent=((t=e.lastnameEmploye)===null||t===void 0?void 0:t.toUpperCase())+" "+e.firstnameEmploye+" ("+e.matricule+")",i.appendChild(n);const o=document.createElement("p");if(o.classList.add("simpleCard__detail-titre-p"),o.textContent=e.email+(e.isAdministrateur===1?" - administrateur":""),i.appendChild(o),e.numConnexions>0){const l=document.createElement("p");l.classList.add("simpleCard__detail-titre-p"),l.classList.add("numConnexions"),l.textContent=e.numConnexions+" connexions",i.appendChild(l)}else{const l=document.createElement("button");l.classList.add("simpleCard__detail-titre-p"),l.classList.add("supprimer-button"),l.textContent="Supprimer",i.appendChild(l),l.removeEventListener("click",()=>u(this,void 0,void 0,function*(){})),l.addEventListener("click",()=>u(this,void 0,void 0,function*(){try{yield C.deleteEmploye(e.matricule),yield I()}catch{alert("Erreur dans la suppression")}}))}return i.addEventListener("click",()=>u(this,void 0,void 0,function*(){console.log("employe = ",e.matricule),x(),a=e,B(e)})),i}function x(){document.querySelector(".employes__detailEmploye")&&(v=!1,f=!1,_(!1),h(!1))}function D(){const e=document.getElementById("title__right-button-Ajouter"),t=document.getElementById("title__right-button-Modifier"),i=document.getElementById("title__right-button-Annuler");if(!e||!t||!i){console.error("Missing one of the action buttons in .right__actions");return}e.style.display="inline-block",t.style.display="inline-block",i.style.display="none",e.removeEventListener("click",()=>{}),e.addEventListener("click",H),t.removeEventListener("click",()=>u(this,void 0,void 0,function*(){})),t.addEventListener("click",()=>u(this,void 0,void 0,function*(){return yield O()})),i.removeEventListener("click",()=>u(this,void 0,void 0,function*(){})),i.addEventListener("click",()=>u(this,void 0,void 0,function*(){return yield U()}))}function H(){f=!0,v=!0;const e=new M({matricule:P+1});a=e,B(e),_(!0),h(!0);const t=document.getElementById("title__right-button-Modifier");t&&(t.textContent="Enregistrer")}function _(e){const t=document.getElementById("title__right-button-Ajouter"),i=document.getElementById("title__right-button-Modifier"),n=document.getElementById("title__right-button-Annuler");!t||!i||!n||(e?(t.style.display="none",n.style.display="inline-block",i.textContent="Enregistrer",A(!0),i.classList.add("inactif"),i.disabled=!0):(t.style.display="inline-block",n.style.display="none",i.textContent="Modifier",A(!1),i.classList.remove("inactif"),i.disabled=!1))}function O(){return u(this,void 0,void 0,function*(){if(v)yield z();else{v=!0,f=!1,_(!0),h(!0);const e=document.getElementById("title__right-button-Modifier");e&&(e.textContent="Enregistrer")}})}function U(){return u(this,void 0,void 0,function*(){f&&(a=g[0]),v=!1,f=!1,_(!1),h(!1);const e=a?.matricule;e?yield C.getEmployesByMatricule(e).then(t=>B(t)).catch(t=>console.error(t)):x()})}function A(e){["firstNameEmploye","lastNameEmploye","email","isAdministrateur","matricule","firstPassword","confirmPassword"].concat(y).forEach(i=>{const n=document.getElementById(i);(n instanceof HTMLInputElement||n instanceof HTMLDivElement)&&(e?(n.addEventListener("input",w),n.addEventListener("blur",w)):(n.removeEventListener("input",w),n.removeEventListener("blur",w)))})}function z(){return u(this,void 0,void 0,function*(){const{employe:e,password:t}=W();if(e)try{yield C.createOrUpdateEmploye(e,t),f?(console.log("Employe created => matricule",e.matricule),alert("Employe cr\xE9\xE9 avec succ\xE8s")):(console.log("Employe updated => matricule",e.matricule),alert("Employe mis \xE0 jour avec succ\xE8s")),yield I()}catch(i){let n="";f?n="Erreur dans la cr\xE9ation du compte ":n="Erreur dans la modification du compte ",console.error(n,i);const o=i.replace(/^Error:\s*Erreur\s*:\s*/,"");alert(n+" => "+o)}finally{v=!1,f=!1,_(!1),h(!1),a=e,yield I()}})}function W(){var e,t,i,n;if(a===void 0)return{employe:void 0,password:""};const o=a;console.log("On sauvegarde = "+o.matricule);const l=document.getElementById("lastNameEmploye");l&&(o.lastnameEmploye=((e=l.textContent)===null||e===void 0?void 0:e.trim())||"");const r=document.getElementById("firstNameEmploye");r&&(o.firstnameEmploye=((t=r.textContent)===null||t===void 0?void 0:t.trim())||"");const c=document.getElementById("email");c&&(o.email=((i=c.textContent)===null||i===void 0?void 0:i.trim())||"");const m=document.getElementById("matricule");m&&(o.matricule=parseInt(((n=m.textContent)===null||n===void 0?void 0:n.trim())||"",10));const d=document.getElementById("isAdministrateur");d&&(o.isAdministrateur=d.checked?1:0);const s=document.getElementById("firstPassword"),E=document.getElementById("confirmPassword");let k="";if(s&&E){const p=s.value.trim(),b=E.value.trim();p===b&&(k=p)}let L="";return y.forEach(p=>{const b=document.getElementById(p);b&&b.checked&&(L+=L.length>0?","+p:p)}),o.listCinemas=L,{employe:o,password:k}}function B(e){var t;const i=document.getElementById("email");i&&(i.textContent=e.email||null);const n=document.getElementById("matricule");n&&(n.textContent=((t=e.matricule)===null||t===void 0?void 0:t.toString(10))||"");const o=document.getElementById("lastNameEmploye");o&&(o.textContent=e.lastnameEmploye||null);const l=document.getElementById("firstNameEmploye");l&&(l.textContent=e.firstnameEmploye||null);const r=document.getElementById("isAdministrateur");r&&(r.checked=e.isAdministrateur===1);const c=document.getElementById("firstPassword");c.value="";const m=document.getElementById("confirmPassword");m.value="",y.forEach(d=>{var s;const E=document.getElementById(d);!((s=e.listCinemas)===null||s===void 0)&&s.includes(d)?E.checked=!0:E.checked=!1})}function G(e){const t=document.querySelector(".passwordEdit");t.style.display=e?"block":"none"}function h(e){const t=["lastNameEmploye","firstNameEmploye","firstPassword","confirmPassword"];f&&(t.push("email"),t.push("matricule")),e||(t.push("email"),t.push("matricule")),t.forEach(n=>{const o=document.getElementById(n);o&&(o instanceof HTMLInputElement?o.disabled=!e:o.contentEditable=e?"true":"false",o.style.border=e?"1px solid #000":"none",o.style.background=e?"rgba(255, 215, 0, 0.1)":"#FFF")}),[...y,"isAdministrateur"].forEach(n=>{const o=document.getElementById(n);o&&(o.disabled=!e)}),G(e);const i=document.getElementsByClassName("span-password");e&&!f?Array.from(i).forEach(n=>{n.style.display="none"}):Array.from(i).forEach(n=>{n.style.display="inline"})}function J(){function e(d){const s=document.getElementById("messageErreur");s.innerHTML=d}e("");let t=!0,i="<h3>Consignes \xE0 respecter :</h3> <ul>";const n=["lastNameEmploye","firstNameEmploye","email","matricule"];let o=!1;for(const d of n){const s=document.getElementById(d);s&&s?.innerText.trim().length===0&&(o=!0)}o&&(t=!1,i+="<li>Nom, Pr\xE9nom, email et matricule sont obligatoires");let l=!1;for(const d of y){const s=document.getElementById(d);if(s?.checked){l=!0;break}}l||(t=!1,i+="<li>Un cin\xE9ma au moins doit etre s\xE9lectionn\xE9");const r=document.getElementById("firstPassword"),c=document.getElementById("confirmPassword");r&&c&&r.value.trim()!==c.value.trim()&&(t=!1,i+="<li>Les deux champs de saisie du mot de passe doivent \xEAtre identiques"),f&&r&&c&&(r.value.trim().length===0||c.value.trim().length===0)&&(t=!1,i+="<li>En mode ajout, vous devez fournir un mot de passe valide");const m=document.getElementById("email");return F(m.textContent||"")||(t=!1,i+="<li>L'email doit \xEAtre valide"),r&&r.value.trim().length>0&&!q(r.value.trim())&&(t=!1,i+="<li>Le mot de passe doit avoir 8 caract\xE8res, une majuscule, un caract\xE8re sp\xE9cial et un nombre"),t?!0:(i+="</ul>",e(i),!1)}function K(){var e;if(!a)return!1;const t=(r,c)=>{const m=document.getElementById(r);return m?.innerText.trim()!==(c||"")};if(t("lastNameEmploye",a.lastnameEmploye)||t("firstNameEmploye",a.firstnameEmploye)||t("email",a.email)||t("matricule",(e=a.matricule)===null||e===void 0?void 0:e.toString(10)))return!0;const i=document.getElementById("firstPassword"),n=document.getElementById("confirmPassword");if(i?.value.trim()!==V||n?.value.trim()!==T)return!0;const l=(a.listCinemas||"").split(",").map(r=>r.trim());a.isAdministrateur===1&&l.push("isAdministrateur");for(const r of[...y,"isAdministrateur"]){const c=document.getElementById(r);if(c){const m=c.checked?1:0,d=l.includes(r)?1:0;if(m!==d)return!0}}return!1}function w(){const e=document.getElementById("title__right-button-Modifier");e&&(e.disabled=!(J()&&K()),e.classList.toggle("inactif",e.disabled))}
