"use strict";var C=function(i,t,n,e){function d(v){return v instanceof n?v:new n(function(r){r(v)})}return new(n||(n=Promise))(function(v,r){function a(o){try{s(e.next(o))}catch(c){r(c)}}function l(o){try{s(e.throw(o))}catch(c){r(c)}}function s(o){o.done?v(o.value):d(o.value).then(a,l)}s((e=e.apply(i,t||[])).next())})};import{DataControllerIntranet as w}from"./DataControllerIntranet.js";import{Salle as F}from"./shared-models/Salle.js";import{chargerMenu as T}from"./ViewMenu.js";import{chargerCinemaSites as j}from"./ViewFooter.js";import{sallesUpdateApi as z,sallesCreateApi as H,sallesDeleteApi as q}from"./NetworkController.js";import{syncTableColumnWidths as U}from"./Helpers.js";import{userDataController as N}from"./DataControllerUser.js";let A=!1,S=[],R="";export function onLoadManageSalles(){return C(this,void 0,void 0,function*(){var i;console.log("=====> chargement onLoadManageSalles"),yield T(),yield j(),yield w.majVersion();let t;N&&(t=N.compte(),t&&t.listCinemas&&(S=(i=t.listCinemas)===null||i===void 0?void 0:i.split(",").map(n=>n.trim().replace(/^"|"$/g,"")),R=t.listCinemas)),console.log("List Cinemas autoris\xE9s = ",R,S),yield V()})}function V(){return C(this,void 0,void 0,function*(){const i=document.getElementById("salles-table-container");if(!i){console.error("Pas de container");return}i.innerHTML="";const t=(yield w.allSalles()).filter(e=>S.includes(e.nameCinema)),n=yield updateTableSalles(t);i.appendChild(n),U(n),initFormulaireSalles("create")})}export function updateTableSalles(i){return C(this,void 0,void 0,function*(){const t=document.createElement("div");t.classList.add("tab__salles-liste");const n=document.createElement("table");n.classList.add("tab__salles-liste-table");const e=document.createElement("thead"),d=document.createElement("tr");["Complexe","Salle","Capacit\xE9","# places PMR","# rang\xE9s","# fauteuils","Plan salle","Actions"].forEach(o=>{const c=document.createElement("th");c.textContent=o,d.appendChild(c)}),e.appendChild(d),n.appendChild(e);const r=document.createElement("tbody");r.classList.add("liste-table__body"),n.appendChild(r);const a=yield D("tr","td","create");a.classList.add("sticky-row"),r.appendChild(a);const l=document.createElement("td"),s=document.createElement("button");return s.textContent="Ajouter une salle",s.classList.add("tab__salles-liste-button"),s.addEventListener("click",()=>C(this,void 0,void 0,function*(){const o=yield $(crypto.randomUUID(),"create");yield H(o),onLoadManageSalles()})),l.appendChild(s),l.appendChild(s),a.appendChild(l),r.appendChild(a),i.forEach(o=>{var c,y,u,p;const m=document.createElement("tr"),g=document.createElement("td");g.textContent=o.nameCinema||"",m.appendChild(g);const x=document.createElement("td");x.textContent=o.nameSalle||"",m.appendChild(x);const E=document.createElement("td");E.textContent=((c=o.capacity)===null||c===void 0?void 0:c.toString(10))||"",m.appendChild(E);const b=document.createElement("td");b.textContent=((y=o.numPMR)===null||y===void 0?void 0:y.toString(10))||"",m.appendChild(b);const h=document.createElement("td");h.textContent=((u=o.rMax)===null||u===void 0?void 0:u.toString(10))||"",m.appendChild(h);const B=document.createElement("td");B.textContent=((p=o.fMax)===null||p===void 0?void 0:p.toString(10))||"",m.appendChild(B);const P=document.createElement("td"),I=_(o?.seatsAbsents||"");P.textContent=I===0?"Plan rectangulaire":`${I} desactiv\xE9(s)`,m.appendChild(P);const k=document.createElement("td"),f=document.createElement("div");f.classList.add("modal-content-btns");const M=document.createElement("button");M.classList.add("tab__salles-liste-button"),M.textContent="Editer",M.addEventListener("click",()=>C(this,void 0,void 0,function*(){yield O(o)})),f.appendChild(M);const L=document.createElement("button");L.classList.add("tab__salles-liste-button"),L.textContent="Supprimer",L.addEventListener("click",()=>{W(o.id)}),f.appendChild(L),k.appendChild(f),m.appendChild(k),r.appendChild(m)}),t.appendChild(n),t})}export function initFormulaireSalles(i){function t(){const a=document.getElementById("seatsAbsentInput"+i),l=document.getElementById("nbSeatsAbsentLabel"+i),s=document.getElementById("divtnPlaces"+i),o=parseInt(n.value,10),c=parseInt(e.value,10),y=a.value;let u=0;!Number.isNaN(o)&&!Number.isNaN(c)?(y&&(u=_(y)),s.textContent=(o*c-u).toString(10),l&&(l.textContent=u===0?"Plan rectangulaire":`${u} desactiv\xE9(s)`)):s.textContent=""}const n=document.getElementById("nrMaxInput"+i),e=document.getElementById("nfMaxInput"+i);n.addEventListener("input",t),e.addEventListener("input",t);const d=document.getElementById("planBtn"+i);d.addEventListener("click",()=>C(this,void 0,void 0,function*(){A=!0;const a=parseInt(document.getElementById("nPlacesPMRInput"+i).value,10),l=parseInt(document.getElementById("nrMaxInput"+i).value,10),s=parseInt(document.getElementById("nfMaxInput"+i).value,10),o=document.getElementById("seatsAbsentInput"+i),c=o.value;if(Number.isNaN(l)||Number.isNaN(s))alert("D\xE9finissez d'abord le rectangle de la salle.");else{const y=yield onClickDisplaySiegeAbsent(l,s,c,a),u=document.getElementById("planBtn"+i),p=_(y);u.textContent=p===0?"Plan rectangulaire":`${p} desactiv\xE9(s)`,y&&(o.value=y),t()}}));const v=document.getElementById("seatsAbsentInput"+i),r=_(v.value);d.textContent=r===0?"Plan rectangulaire":`${r} desactiv\xE9(s)`}export function createCinemaDropdown(i,t){const n=document.createElement("div");n.style.position="relative";const e=document.createElement("button");e.className="title__filter-dropdown-button titre__filter-dropdown-complexe",e.style.display="block",e.id="titre__filter-dropdown-complexe"+t,e.innerHTML=`${i} <span class="chevron">\u25BC</span>`,n.appendChild(e);const d=document.createElement("div");return d.className="title__filter-button-drowdown-content title__filter-button-drowdown-content-complexe",d.style.display="none",d.style.position="absolute",d.style.zIndex="1000",d.style.backgroundColor="#fff",S.forEach(r=>{const a=document.createElement("a");a.href="#",a.textContent=r,a.dataset.cinema=r,a.addEventListener("click",l=>{l.preventDefault(),e.innerHTML=`${r} <span class="chevron">\u25BC</span>`,d.style.display="none"}),d.appendChild(a)}),n.appendChild(d),e.addEventListener("click",r=>{r.stopPropagation(),d.style.display=d.style.display==="block"?"none":"block"}),document.addEventListener("click",()=>d.style.display="none"),n}function O(i){return C(this,void 0,void 0,function*(){let t=document.getElementById("modal-editSalle");t||(t=document.createElement("div"),t.id="modal-editSalle",t.classList.add("modal"),document.body.appendChild(t),t.innerHTML="");const e=`
    <div class="modal__content-wrapper">
        <div class="modal__title">
            <div class="title__editSalle title-h2">
                <h2>${`${i.nameSalle} \xE0 ${i.nameCinema}`}</h2>
            </div>
            <span class="close-modal" id="close-editSalle">\xD7</span>
        </div>
        <div class="modal__content form__group" id="content__editSalle" flex-direction>
        </div>
    </div>`;t.innerHTML=e,t.style.zIndex="1000",document.body.appendChild(t),t.style.display="flex";const d=document.getElementById("close-editSalle"),v=()=>{t.style.display="none",t.remove};d?.addEventListener("click",v),t.addEventListener("click",c=>{c.target===t&&v()});const r=document.getElementById("content__editSalle"),a=yield D("div","div","table",i);r.appendChild(a),initFormulaireSalles("table");const l=document.createElement("div");l.classList.add("modal-content-btns");const s=document.createElement("button");s.classList.add("button"),s.id="annBtn",s.textContent="Annuler",l.appendChild(s),s?.addEventListener("click",v);const o=document.createElement("button");o.classList.add("button"),o.id="saveButton",l.appendChild(o),o.textContent="Enregistrer",l.appendChild(o),o.removeEventListener("click",()=>C(this,void 0,void 0,function*(){})),o.addEventListener("click",()=>C(this,void 0,void 0,function*(){const c=yield $(i.id,"table");yield z(i.id,c),v(),onLoadManageSalles()})),r.appendChild(l)})}function W(i){return C(this,void 0,void 0,function*(){try{yield q(i),onLoadManageSalles()}catch(t){alert("Suppression impossible "+t)}})}function D(i,t,n,e){return C(this,void 0,void 0,function*(){const d=document.createElement(i),v=document.createElement(t);v.appendChild(createCinemaDropdown(e?.nameCinema||S[0],n)),n==="table"&&v.classList.add("form__group"),d.appendChild(v);const r=document.createElement(t),a=document.createElement("input");if(a.type="text",a.id="nameSalleInput"+n,a.placeholder="Nom de la salle",e?.nameSalle&&(a.value=e.nameSalle),a.required=!0,n==="table"){r.classList.add("form__group");const h=document.createElement("label");h.htmlFor="nameSalleInput"+n,h.textContent="Nom de la salle :",r.appendChild(h)}r.appendChild(a),d.appendChild(r);const l=document.createElement(t),s=document.createElement("label");s.id="divtnPlaces"+n,s.textContent=((e?.fMax||0)*(e?.rMax||0)-_(e?.seatsAbsents||"")).toString(10),n==="table"&&(r.classList.add("form__group"),s.textContent="Capacit\xE9 : "+s.textContent),l.appendChild(s),d.appendChild(l);const o=document.createElement(t),c=document.createElement("input");if(c.type="numeric",c.id="nPlacesPMRInput"+n,c.placeholder="Places PMR",c.required=!0,c.step="1",c.max="20",c.min="0",e?.numPMR&&(c.value=e.numPMR.toString(10)),n==="table"){o.classList.add("form__group");const h=document.createElement("label");h.htmlFor="nPlacesPMRInput"+n,h.textContent="Nombre de places PMR :",o.appendChild(h)}o.appendChild(c),d.appendChild(o);const y=document.createElement(t),u=document.createElement("input");if(u.type="numeric",u.id="nrMaxInput"+n,u.placeholder="Nombre rang\xE9es",u.required=!0,u.step="1",u.max="50",u.min="5",e?.rMax&&(u.value=e.rMax.toString(10)),n==="table"){y.classList.add("form__group");const h=document.createElement("label");h.htmlFor="nrMaxInput"+n,h.textContent="Nombre de rang\xE9es :",y.appendChild(h)}y.appendChild(u),d.appendChild(y);const p=document.createElement(t),m=document.createElement("input");if(m.type="numeric",m.id="nfMaxInput"+n,m.placeholder="Nombre fauteuils par rang\xE9e",m.required=!0,m.step="1",m.max="50",m.min="5",n==="table"){p.classList.add("form__group");const h=document.createElement("label");h.htmlFor="nfMaxInput"+n,h.textContent="Nombre de fauteuils par rang\xE9es :",p.appendChild(h)}e?.fMax&&(m.value=e.fMax.toString(10)),p.appendChild(m);const g=document.createElement(t),x=document.createElement("input");x.type="hidden",x.id="seatsAbsentInput"+n,e?.seatsAbsents&&(x.value=e.seatsAbsents),p.appendChild(x),d.appendChild(p);const E=document.createElement("td"),b=document.createElement("button");return b.classList.add("tab__salles-liste-button"),b.textContent="D\xE9finir...",b.id="planBtn"+n,E.appendChild(b),d.appendChild(E),d})}function $(i,t){return C(this,void 0,void 0,function*(){var n,e,d,v,r,a;const l=new F({id:i}),s=document.getElementById("titre__filter-dropdown-complexe"+t);s&&(l.nameCinema=((n=s.textContent)===null||n===void 0?void 0:n.replace("\u25BC","").trim())||S[0]),console.log("Nom cinema = ",l.nameCinema);const o=document.getElementById("nameSalleInput"+t);o&&(l.nameSalle=((e=o.value)===null||e===void 0?void 0:e.trim())||"");const c=document.getElementById("nPlacesPMRInput"+t);c&&(l.numPMR=parseInt(((d=c.value)===null||d===void 0?void 0:d.trim())||"0",10)||0);const y=document.getElementById("nrMaxInput"+t);y&&(l.rMax=parseInt(((v=y.value)===null||v===void 0?void 0:v.trim())||"0",10)||0);const u=document.getElementById("nfMaxInput"+t);u&&(l.fMax=parseInt(((r=u.value)===null||r===void 0?void 0:r.trim())||"0",10)||0);const p=document.getElementById("seatsAbsentInput"+t);return p&&(l.seatsAbsents=((a=p.value)===null||a===void 0?void 0:a.trim())||""),l.capacity=(l?.fMax||0)*(l?.rMax||0)-_(l?.seatsAbsents||""),console.log("Salle du formulaire",JSON.stringify(l)),l})}export function onClickDisplaySiegeAbsent(i,t,n,e){return C(this,void 0,void 0,function*(){const d=n.length>0?n.split(",").map(v=>v.trim().replace(/^"|"$/g,"")):[];return new Promise(v=>{const r=`
      <div class="modal__content-wrapper" id="modal-displayAndSeatsSuppr">
        <div class="modal__title">
          <div class="title__displayAndSeatsSuppr title-h2">
            <h2>S\xE9lectionner les places absentes</h2>
          </div>
          <span class="close-modal" id="close-displayAndSeatsSuppr">\xD7</span>
        </div>
        <div class="modal__content" id="content__displayAndSeatsSuppr"></div>
        <div class="modal__footer" style="margin-top: 10px; display:flex; gap:10px; justify-content: end;">
          <button id="btnAnnulerSeats" class="button">Annuler</button>
          <button id="btnValiderSeats" class="button">Valider</button>
        </div>
      </div>`;let a=document.getElementById("modal-displayAndSeatsSuppr");a||(a=document.createElement("div"),a.id="modal-displayAndSeatsSuppr",a.classList.add("modal"),a.style.zIndex="2000",document.body.appendChild(a),a.innerHTML=""),a.innerHTML=r,a.style.display="flex";const l=document.getElementById("close-displayAndSeatsSuppr"),s=document.getElementById("content__displayAndSeatsSuppr"),o=document.getElementById("btnAnnulerSeats"),c=document.getElementById("btnValiderSeats"),y=d,u=p=>{if(a.style.display="none",A)A=!1;else{const m=document.getElementById("modal-editSalle");m&&m.style.display==="none"&&(m.style.display="flex")}a.remove,p.length===0?v(""):v(p.join(","))};if(l?.addEventListener("click",p=>{p.stopPropagation(),u([])}),a.addEventListener("click",p=>{p.stopPropagation(),p.target===a&&u([])}),o?.addEventListener("click",p=>{p.stopPropagation(),u([])}),c?.removeEventListener("click",()=>{}),c?.addEventListener("click",p=>{p.stopPropagation(),u([...y])}),s)for(let p=0;p<i;p++){const m=document.createElement("div");m.style.display="flex",m.style.flexDirection="row",m.style.margin="2px 0";const g=document.createElement("span");g.textContent=`R${p} `,g.style.width="40px",g.style.textAlign="right",m.appendChild(g);for(let x=0;x<t;x++){const E=`R${p}F${x}`,b=document.createElement("div");b.style.width="30px",b.style.height="30px",b.style.marginRight="4px",b.style.display="flex",b.style.alignItems="center",b.style.justifyContent="center",b.style.cursor="pointer",b.style.fontSize="0.7em",b.style.borderRadius="4px",p===0&&x<e&&(b.textContent="PMR"),d&&d.includes(E)?b.style.backgroundColor="white":b.style.backgroundColor="lightgray",b.removeEventListener("click",()=>{}),b.addEventListener("click",()=>{y.includes(E)?(y.splice(y.indexOf(E),1),b.style.backgroundColor="lightgray"):(y.push(E),b.style.backgroundColor="white")}),m.appendChild(b)}s.appendChild(m)}})})}function _(i){return i.length>0?(i.match(/,/g)||[]).length+1:0}
