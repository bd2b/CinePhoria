"use strict";var m=function(e,t,n,i){function o(l){return l instanceof n?l:new n(function(r){r(l)})}return new(n||(n=Promise))(function(l,r){function c(s){try{d(i.next(s))}catch(E){r(E)}}function f(s){try{d(i.throw(s))}catch(E){r(E)}}function d(s){s.done?l(s.value):o(s.value).then(c,f)}d((i=i.apply(e,t||[])).next())})};import{DataControllerIntranet as b}from"./DataControllerIntranet.js";import{ComptePersonne as S}from"./shared-models/Utilisateur.js";import{chargerMenu as F}from"./ViewMenu.js";import{chargerCinemaSites as T}from"./ViewFooter.js";import{listCinemasConst as y,validateEmail as q,isPasswordValid as V}from"./Helpers.js";let v=!1,u=!1,a,g=[],D="",j="",M=0;export function onLoadManageEmployes(){return m(this,void 0,void 0,function*(){console.log("=====> chargement onLoadManageEmployes"),yield F(),yield T(),yield x(),O(),h(!1)})}function x(){return m(this,void 0,void 0,function*(){const e=document.querySelector(".employes__listEmployes");if(e&&(e.innerHTML="",g=yield b.getListEmployesAll(),M=g.reduce((t,n)=>{var i;return Math.max(t,(i=n.matricule)!==null&&i!==void 0?i:0)},0),g.forEach(t=>{const n=H(t);e.appendChild(n)}),g.length>0?(a=g[0],B(a)):L(),a)){const t=[...e.querySelectorAll(".listEmployes__simpleCard")].find(n=>{var i,o;return(i=n.textContent)===null||i===void 0?void 0:i.includes(((o=a.matricule)===null||o===void 0?void 0:o.toString(10))||"")});t&&t.scrollIntoView({behavior:"smooth",block:"center"})}})}function H(e){var t;const n=document.createElement("div");n.classList.add("listEmployes__simpleCard");const i=document.createElement("p");i.classList.add("simpleCard__detail-titre-p"),i.textContent=((t=e.lastnameEmploye)===null||t===void 0?void 0:t.toUpperCase())+" "+e.firstnameEmploye+" ("+e.matricule+")",n.appendChild(i);const o=document.createElement("p");if(o.classList.add("simpleCard__detail-titre-p"),o.textContent=e.email+(e.isAdministrateur===1?" - administrateur":""),n.appendChild(o),e.numConnexions>0){const l=document.createElement("p");l.classList.add("simpleCard__detail-titre-p"),l.classList.add("numConnexions"),l.textContent=e.numConnexions+" connexions",n.appendChild(l)}else{const l=document.createElement("button");l.classList.add("simpleCard__detail-titre-p"),l.classList.add("supprimer-button"),l.textContent="Supprimer",n.appendChild(l),l.removeEventListener("click",()=>m(this,void 0,void 0,function*(){})),l.addEventListener("click",()=>m(this,void 0,void 0,function*(){try{yield b.deleteEmploye(e.matricule),yield x()}catch{alert("Erreur dans la suppression")}}))}return n.addEventListener("click",()=>m(this,void 0,void 0,function*(){console.log("employe = ",e.matricule),L(),a=e,B(e)})),n}function L(){document.querySelector(".employes__detailEmploye")&&(v=!1,u=!1,C(!1),h(!1))}function O(){const e=document.getElementById("title__right-button-Ajouter"),t=document.getElementById("title__right-button-Modifier"),n=document.getElementById("title__right-button-Annuler");if(!e||!t||!n){console.error("Missing one of the action buttons in .right__actions");return}e.style.display="inline-block",t.style.display="inline-block",n.style.display="none",e.removeEventListener("click",()=>{}),e.addEventListener("click",U),t.removeEventListener("click",()=>m(this,void 0,void 0,function*(){})),t.addEventListener("click",()=>m(this,void 0,void 0,function*(){return yield z()})),n.removeEventListener("click",()=>m(this,void 0,void 0,function*(){})),n.addEventListener("click",()=>m(this,void 0,void 0,function*(){return yield W()}))}function U(){u=!0,v=!0;const e=new S({matricule:M+1});a=e,B(e),C(!0),h(!0);const t=document.getElementById("title__right-button-Modifier");t&&(t.textContent="Enregistrer")}function C(e){const t=document.getElementById("title__right-button-Ajouter"),n=document.getElementById("title__right-button-Modifier"),i=document.getElementById("title__right-button-Annuler");!t||!n||!i||(e?(t.style.display="none",i.style.display="inline-block",n.textContent="Enregistrer",N(!0),n.classList.add("inactif"),n.disabled=!0):(t.style.display="inline-block",i.style.display="none",n.textContent="Modifier",N(!1),n.classList.remove("inactif"),n.disabled=!1))}function z(){return m(this,void 0,void 0,function*(){if(v)yield G();else{v=!0,u=!1,C(!0),h(!0);const e=document.getElementById("title__right-button-Modifier");e&&(e.textContent="Enregistrer")}})}function W(){return m(this,void 0,void 0,function*(){u&&(a=g[0]),v=!1,u=!1,C(!1),h(!1);const e=a?.matricule;e?yield b.getEmployesByMatricule(e).then(t=>B(t)).catch(t=>console.error(t)):L()})}function N(e){["firstNameEmploye","lastNameEmploye","email","isAdministrateur","matricule","firstPassword","confirmPassword"].concat(y).forEach(n=>{const i=document.getElementById(n);(i instanceof HTMLInputElement||i instanceof HTMLDivElement)&&(e?(i.addEventListener("input",I),i.addEventListener("blur",I)):(i.removeEventListener("input",I),i.removeEventListener("blur",I)))})}function G(){return m(this,void 0,void 0,function*(){const{employe:e,password:t}=J();if(e)try{yield b.createOrUpdateEmploye(e,t),u?(console.log("Employe created => matricule",e.matricule),alert("Employe cr\xE9\xE9 avec succ\xE8s")):(console.log("Employe updated => matricule",e.matricule),alert("Employe mis \xE0 jour avec succ\xE8s")),yield x()}catch(n){let i="";u?i="Erreur dans la cr\xE9ation du compte ":i="Erreur dans la modification du compte ",console.error(i,n);const o=n.replace(/^Error:\s*Erreur\s*:\s*/,"");alert(i+" => "+o)}finally{v=!1,u=!1,C(!1),h(!1),a=e,yield x()}})}function J(){var e,t,n,i,o,l;if(a===void 0)return{employe:void 0,password:""};const r=a;console.log("On sauvegarde = "+r.matricule);const c=document.getElementById("lastNameEmploye");c&&(r.lastnameEmploye=((e=c.textContent)===null||e===void 0?void 0:e.trim())||"");const f=document.getElementById("firstNameEmploye");f&&(r.firstnameEmploye=((t=f.textContent)===null||t===void 0?void 0:t.trim())||"");const d=document.getElementById("email");d&&(r.email=((n=d.textContent)===null||n===void 0?void 0:n.trim())||"");const s=document.getElementById("matricule");s&&(r.matricule=parseInt(((i=s.textContent)===null||i===void 0?void 0:i.trim())||"",10));const E=document.getElementById("isAdministrateur");E&&(r.isAdministrateur=E.checked?1:0);const k=document.getElementById("firstPassword"),P=document.getElementById("confirmPassword");let A="";if(k&&P){const p=((o=k.textContent)===null||o===void 0?void 0:o.trim())||"",_=((l=P.textContent)===null||l===void 0?void 0:l.trim())||"";p===_&&(A=p)}let w="";return y.forEach(p=>{const _=document.getElementById(p);_&&_.checked&&(w+=w.length>0?","+p:p)}),r.listCinemas=w,{employe:r,password:A}}function B(e){var t;const n=document.getElementById("email");n&&(n.textContent=e.email||null);const i=document.getElementById("matricule");i&&(i.textContent=((t=e.matricule)===null||t===void 0?void 0:t.toString(10))||"");const o=document.getElementById("lastNameEmploye");o&&(o.textContent=e.lastnameEmploye||null);const l=document.getElementById("firstNameEmploye");l&&(l.textContent=e.firstnameEmploye||null);const r=document.getElementById("isAdministrateur");r&&(r.checked=e.isAdministrateur===1);const c=document.getElementById("firstPassword");c&&(c.textContent="");const f=document.getElementById("confirmPassword");f&&(f.textContent=""),y.forEach(d=>{var s;const E=document.getElementById(d);!((s=e.listCinemas)===null||s===void 0)&&s.includes(d)?E.checked=!0:E.checked=!1})}function K(e){const t=document.querySelector(".passwordEdit");t.style.display=e?"block":"none"}function h(e){const t=["lastNameEmploye","firstNameEmploye","firstPassword","confirmPassword"];u&&(t.push("email"),t.push("matricule")),e||(t.push("email"),t.push("matricule")),t.forEach(i=>{const o=document.getElementById(i);o&&(o.contentEditable=e?"true":"false",o.style.border=e?"1px solid #000":"none",o.style.background=e?"rgba(255, 215, 0, 0.1)":"#FFF")}),[...y,"isAdministrateur"].forEach(i=>{const o=document.getElementById(i);o&&(o.disabled=!e)}),K(e);const n=document.getElementsByClassName("span-password");e&&!u?Array.from(n).forEach(i=>{i.style.display="none"}):Array.from(n).forEach(i=>{i.style.display="inline"})}function Q(){function e(d){const s=document.getElementById("messageErreur");s.innerHTML=d}e("");let t=!0,n="<h3>Consignes \xE0 respecter :</h3> <ul>";const i=["lastNameEmploye","firstNameEmploye","email","matricule"];let o=!1;for(const d of i){const s=document.getElementById(d);if(s&&s?.innerText.trim().length>0){o=!0;break}}o||(t=!1,n+="<li>Nom, Pr\xE9nom, email et matricule sont obligatoires");let l=!1;for(const d of y){const s=document.getElementById(d);if(s?.checked){l=!0;break}}l||(t=!1,n+="<li>Un cin\xE9ma au moins doit etre s\xE9lectionn\xE9");const r=document.getElementById("firstPassword"),c=document.getElementById("confirmPassword");r&&c&&r.innerText.trim()!==c.innerText.trim()&&(t=!1,n+="<li>Les deux champs de saisie du mot de passe doivent \xEAtre identiques"),u&&r&&c&&(r.innerText.trim().length===0||c.innerText.trim().length===0)&&(t=!1,n+="<li>En mode ajout, vous devez fournir un mot de passe valide");const f=document.getElementById("email");return q(f.textContent||"")||(t=!1,n+="<li>L'email doit \xEAtre valide"),r&&r.innerText.trim().length>0&&!V(r.innerText.trim())&&(t=!1,n+="<li>Le mot de passe doit avoir 8 caract\xE8res, une majuscule, un caract\xE8re sp\xE9cial et un nombre"),t?!0:(n+="</ul>",e(n),!1)}function R(){var e;if(!a)return!1;const t=(o,l)=>{const r=document.getElementById(o);return r?.innerText.trim()!==(l||"")};if(t("lastNameEmploye",a.lastnameEmploye)||t("firstNameEmploye",a.firstnameEmploye)||t("email",a.email)||t("matricule",(e=a.matricule)===null||e===void 0?void 0:e.toString(10))||t("firstPassword",D)||t("confirmPassword",j))return!0;const i=(a.listCinemas||"").split(",").map(o=>o.trim());a.isAdministrateur===1&&i.push("isAdministrateur");for(const o of[...y,"isAdministrateur"]){const l=document.getElementById(o);if(l){const r=l.checked?1:0,c=i.includes(o)?1:0;if(r!==c)return!0}}return!1}function I(){const e=document.getElementById("title__right-button-Modifier");e&&(e.disabled=!(Q()&&R()),e.classList.toggle("inactif",e.disabled))}
