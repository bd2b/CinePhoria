"use strict";var p=function(u,g,s,o){function f(r){return r instanceof s?r:new s(function(m){m(r)})}return new(s||(s=Promise))(function(r,m){function d(i){try{a(o.next(i))}catch(n){m(n)}}function e(i){try{a(o.throw(i))}catch(n){m(n)}}function a(i){i.done?r(i.value):f(i.value).then(d,e)}a((o=o.apply(u,g||[])).next())})};import{validateEmail as y}from"./Helpers.js";import{dataController as h}from"./DataController.js";import{userDataController as l}from"./DataControllerUser.js";import{loginApi as w}from"./NetworkController.js";import{confirmReserve as _}from"./ViewReservationPlaces.js";import{ReservationState as L}from"./shared-models/Reservation.js";const x=`
<!-- Modale loginWithEmail -->  
    <div id="modal-loginEmail" class="modal">
        <div class="modal__content-wrapper">
            <div class="modal__title">
                <div class="title__loginEmail title-h2">
                    <h2>Connexion</h2>
                </div>
                <!-- Bouton (X) ou autre m\xE9canisme pour fermer la modale si besoin -->
                <span class="close-modal" id="close-loginEmail">\xD7</span>
            </div>
            <div class="modal__content">
                <div class="title-p" id="invite-p">
                    <p>Veuillez vous connecter pour valider la r\xE9servation.</p>
                </div>
                <!-- Email -->
                <div class="form__group">
                    <label for="loginEmail-email">Email :</label>
                    <input type="email" id="loginEmail-email" class="input__mail" disabled />
                    <span id="email-error" class="error-message"></span>
                </div>
                <!-- Mot de passe -->
                <div class="form__group">
                    <label for="loginEmail-password">Mot de passe :</label>
                    <input type="password" id="loginEmail-password" />
                </div>
                <!-- Bouton de validation -->
                <button id="loginEmail-submit" class="button button-primary" disabled>
                    Connexion
                </button>
                <span id="login-error" class="error-message" hidden="true">-</span>
            </div>
        </div>
    </div>`;export function login2(){return p(this,arguments,void 0,function*(u="",g=!1){console.log("===> login action");const s=document.createElement("div");s.innerHTML=x,document.body.appendChild(s);const o=document.getElementById("modal-loginEmail"),f=document.getElementById("close-loginEmail"),r=document.getElementById("loginEmail-submit");if(o&&f&&r){o.style.display="flex";const d=()=>{o.style.display="none",window.location.reload()};f.addEventListener("click",d),o.addEventListener("click",e=>{e.target===o&&d()}),yield m()}else console.error("Un ou plusieurs \xE9l\xE9ments requis pour le fonctionnement de la modal modal-loginEmail sont introuvables.");function m(){return p(this,void 0,void 0,function*(){const d=document.getElementById("invite-p"),e=document.getElementById("loginEmail-email"),a=document.getElementById("loginEmail-password"),i=document.getElementById("email-error"),n=document.getElementById("login-error"),c=document.getElementById("loginEmail-submit");d?d.innerHTML="<p>"+u+"</p>":console.log("Pas d'invite dans la modale"),e.disabled=!g;function b(){return e.value.trim()!==""&&a.value.trim()!==""}function E(){const v=y(e.value),t=b();v&&t?(c.classList.remove("inactif"),c.disabled=!1,n.hidden=!0):(c.classList.add("inactif"),c.disabled=!0)}e.value=h.selectedUtilisateurMail||"",c.classList.add("inactif"),i.textContent="",e.addEventListener("blur",()=>{y(e.value)?i.textContent="":(i.textContent="Email invalide (exemple: utilisateur@domaine.com)",i.style.color="red")}),e.addEventListener("input",E),a.addEventListener("input",E),c.removeEventListener("click",v=>p(this,void 0,void 0,function*(){})),c.addEventListener("click",v=>p(this,void 0,void 0,function*(){if(v.preventDefault(),v.stopPropagation(),h.reservationState===L.ReserveToConfirm)try{yield w(e.value.trim(),a.value.trim()),console.log("Connexion workflow reservation r\xE9ussie"),o&&(o.style.display="none"),l.ident=e.value.trim(),yield l.init(),yield _();const t=l.profil();window.location.href=t}catch(t){console.log(t),n.hidden=!1,n.textContent=t,n.style.color="red"}else try{yield w(e.value.trim(),a.value.trim()),console.log("Connexion simple r\xE9ussie"),o&&(o.style.display="none"),console.log("email logu\xE9 = ",e.value.trim()),l.ident=e.value.trim(),console.log("ident stock\xE9e = ",l.ident),yield l.init(),console.log("Compte charge = ",l.compte());const t=l.profil();console.log("Page redirig\xE9e",t),window.location.href=t}catch(t){console.log(t),n.hidden=!1,n.textContent=t,n.style.color="red"}}))})}})}export function logout2(){return p(this,void 0,void 0,function*(){try{localStorage.removeItem("jwtAccessToken"),l.invalidate(),window.location.href="visiteur.html"}catch(u){console.error(u)}})}
