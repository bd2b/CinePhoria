"use strict";var _=function(e,t,i,r){function l(n){return n instanceof i?n:new i(function(s){s(n)})}return new(i||(i=Promise))(function(n,s){function u(o){try{a(r.next(o))}catch(d){s(d)}}function m(o){try{a(r.throw(o))}catch(d){s(d)}}function a(o){o.done?n(o.value):l(o.value).then(u,m)}a((r=r.apply(e,t||[])).next())})};import{showCustomAlert as F}from"./Helpers.js";import{dataController as c,dataReady as V}from"./DataController.js";import{formatDateLocalYYYYMMDD as b,imageFilm as P}from"./Helpers.js";import{ReservationState as z}from"./shared-models/Reservation.js";import{chargerMenu as O}from"./ViewMenu.js";import{chargerCinemaSites as K}from"./ViewFooter.js";import{isUUID as Y}from"./Helpers.js";let B="";export function onLoadFilms(){return _(this,void 0,void 0,function*(){console.log("=====> chargement onLoadFilms"),yield V,console.log("Donn\xE9es charg\xE9es, traitement de la page Films..."),yield O(),yield K(),yield W(),yield k(),yield X(),L(),document.querySelector("main").style.visibility="visible";const e=document.querySelector(".title__filters");e&&(e.style.visibility="visible");const t=document.getElementById("progressIndicator");t?(t.style.removeProperty("display"),t.style.display="none",t.classList.add("hidden"),console.log("Descativation progress")):console.error("Pas d'indicateur")})}function W(){return _(this,void 0,void 0,function*(){function e(n){document.querySelectorAll(".titre__filter-dropdown-complexe").forEach(u=>{u.style.display="block",u.innerHTML=`${n} <span class="chevron">\u25BC</span>`})}const t=document.querySelector(".titre__filter-dropdown-cinema");if(!t)return;const i=t.querySelector(".title__filter-button-drowdown-content");if(!i)return;console.log("Init dropdown Cinema");const r=document.getElementById("titleLeft");r&&(c.filterNameCinema==="all"?r.innerText="Les films de CinePhoria":r.innerText=`Les films de CinePhoria \xE0 ${c.filterNameCinema}`),c.filterNameCinema==="all"?e("Tous les complexes"):e(c.filterNameCinema),i.querySelectorAll("a").forEach(n=>{n.removeEventListener("click",s=>_(this,void 0,void 0,function*(){})),n.addEventListener("click",s=>_(this,void 0,void 0,function*(){var u;s.preventDefault();const m=((u=n.dataset.cinema)===null||u===void 0?void 0:u.trim())||"";m==="Tous les complexes"?c.filterNameCinema="all":c.filterNameCinema=m,console.log("Choix du filtre Cinema = ",c.filterNameCinema),e(m);const a=document.getElementById("titleLeft");a&&(c.filterNameCinema==="all"?a.innerText="Les films de CinePhoria":a.innerText=`Les films de CinePhoria \xE0 ${m}`),yield c.init(),yield k(),yield x(),yield L()}))})})}function k(){return _(this,void 0,void 0,function*(){function e(l){const n=document.getElementById("title__filter-dropdown-button-genre");n&&(n.innerHTML=`${l} <span class="chevron">\u25BC</span>`)}const t=document.querySelector(".titre__filter-dropdown-genre");if(!t)return;const i=t.querySelector(".title__filter-button-drowdown-content");if(!i)return;i.innerHTML="";const r=document.createElement("a");r.href="#",r.textContent="Tous les genres",r.addEventListener("click",l=>_(this,void 0,void 0,function*(){l.preventDefault(),c.filterGenre="all",e("Tous les genres"),yield x(),yield L()})),i.appendChild(r),c.genreSet.forEach(l=>{const n=document.createElement("a");n.href="#",n.textContent=l,n.addEventListener("click",s=>_(this,void 0,void 0,function*(){s.preventDefault(),c.filterGenre=l,e(l),yield x(),yield L()})),i.appendChild(n)})})}function X(){return _(this,void 0,void 0,function*(){let e=document.querySelector(".title__filters-films");if(!e)return;let t=document.createElement("input");t.type="date",t.classList.add("filter-jour-input"),e.prepend(t),t.removeEventListener("change",()=>_(this,void 0,void 0,function*(){})),t.addEventListener("change",()=>_(this,void 0,void 0,function*(){B=t.value,yield L()})),yield x()})}function x(){return _(this,void 0,void 0,function*(){const e=document.querySelector(".filter-jour-input");if(!e)return;const t=c.filmsGenre,i=new Set(t.map(n=>n.id)),l=c.seances.filter(n=>n.filmId!==void 0&&i.has(n.filmId)).map(n=>n.dateJour).filter(Boolean).sort();if(l.length>0){const n=b(new Date(l[0])),s=b(new Date(l[l.length-1]));e.min=n,e.max=s}else e.min="",e.max=""})}function L(){return _(this,void 0,void 0,function*(){const e=document.querySelector(".films__listFilms");if(!e)return;e.innerHTML="";let t=c.filmsGenre;if(B&&(t=t.filter(i=>c.seancesFilm(i.id).some(l=>l.dateJour?b(new Date(l.dateJour))===B:!1))),t.forEach(i=>{const r=Z(i);e.appendChild(r)}),t.length>0){const i=c.selectedFilmUUID;if(i){const r=t.find(l=>l.id===i);r&&H(r)}else H(t[0])}else ee()})}function Z(e){var t,i,r,l;const n=document.createElement("div");n.classList.add("listFilms__simpleCard");const s=document.createElement("img");s.src=`${P((t=e.imageFilm1024)!==null&&t!==void 0?t:"")}`,s.alt="Affiche",s.classList.add("simpleCard__affiche-img");const u=document.createElement("div");u.classList.add("simpleCard__detail");const m=document.createElement("p");m.classList.add("simpleCard__detail-titre-p"),m.textContent=(i=e.titleFilm)!==null&&i!==void 0?i:"Sans Titre";const a=document.createElement("div");if(a.classList.add("simpleCard__evaluation"),e.isCoupDeCoeur){const v=document.createElement("div");v.classList.add("evaluation__coupdecoeur");const f=document.createElement("p");f.classList.add("evaluation__coupdecoeur-p"),f.textContent="Coup de coeur";const h=document.createElement("img");h.src="assets/heart.svg",h.alt="Coeur",h.classList.add("evaluation__coupdecoeur-img"),v.append(f,h),a.appendChild(v)}const o=document.createElement("div");o.classList.add("evaluation__note");const d=document.createElement("p");d.classList.add("evaluation__note-p"),d.textContent=`Avis : ${(r=e.note)!==null&&r!==void 0?r:0} / 5`,o.appendChild(d),a.appendChild(o);const p=document.createElement("p");return p.classList.add("simpleCard__detail-pitch-p"),p.textContent=(l=e.filmPitch)!==null&&l!==void 0?l:"",u.append(m,a,p),n.append(s,u),n.addEventListener("click",()=>{H(e)}),n}function H(e){return _(this,void 0,void 0,function*(){var t,i,r,l,n,s,u,m,a;const o=document.querySelector(".films__detailFilm");if(!o)return;const d=o.querySelector(".twocolumns__left-img");d&&(d.src=`${P((t=e.imageFilm1024)!==null&&t!==void 0?t:"")}`,d.alt=(i=e.titleFilm)!==null&&i!==void 0?i:"Affiche");const p=o.querySelector(".right__title-p");p&&(p.textContent=(r=e.titleFilm)!==null&&r!==void 0?r:"");const v=o.querySelector(".caractFilm__genre-p");v&&(v.textContent=(l=e.genreArray)!==null&&l!==void 0?l:"");const f=o.querySelector(".caractFilm__duree-p");f&&(f.textContent=(n=e.duration)!==null&&n!==void 0?n:"");const h=o.querySelector(".caractFilm__public-p");h&&(h.textContent=(s=e.categorySeeing)!==null&&s!==void 0?s:"");const w=o.querySelector(".right__description-p");w&&(w.textContent=(u=e.filmDescription)!==null&&u!==void 0?u:"");const g=o.querySelector(".right__author-p");g&&(g.textContent=(m=e.filmAuthor)!==null&&m!==void 0?m:"");const S=o.querySelector(".right__distribution");S&&(S.textContent=(a=e.filmDistribution)!==null&&a!==void 0?a:"");const D=e.linkBO;D&&ne(D);const C=o.querySelector(".right__film");if(!C)return;const E=C.querySelector(".table-scroll");E&&E.remove();const y=te(e);C.appendChild(y);const M=o.querySelector(".right__jereserve-button");M&&(M.disabled=!0,M.addEventListener("click",()=>_(this,void 0,void 0,function*(){if(!J)yield F("Veuillez s\xE9lectionner une s\xE9ance dans la liste.");else if(["ReserveCompteToConfirm","ReserveMailToConfirm","ReserveToConfirm"].includes(c.reservationState)&&Y(c.selectedReservationUUID||"")&&Y(c.selectedSeanceUUID||""))yield F("Une autre r\xE9servation est en cours, vous devez la finaliser ou l'annuler avant d'en effectuer une nouvelle"),window.location.href="reservation.html";else{const{Jour:N,Cinema:U,Horaire:G,Qualite:R,Tarifs:j,SeanceId:T}=J,I=c.seances.find(Q=>Q.seanceId===T),$=yield c.getSeanceFromDB([T]);let A=-1;$[0].numFreeSeats&&(A=parseInt($[0].numFreeSeats,10)),I&&A>0?(c.filterNameCinema=U,c.selectedSeanceUUID=T,c.selectedFilmUUID=I.filmId||"",c.selectedSeanceDate=new Date(I.dateJour||""),c.reservationState=z.PendingChoiceSeats,yield c.sauverEtatGlobal(),window.location.href="reservation.html",yield F(`S\xE9ance s\xE9lectionn\xE9e :
Jour : ${N}
Cin\xE9ma : ${U}
Horaire : ${G}
Qualit\xE9 : ${R}
Tarifs : ${j}`)):yield F("La s\xE9ance est compl\xE8te")}})))})}function ee(){const e=document.querySelector(".films__detailFilm");if(!e)return;const t=e.querySelector(".twocolumns__left-img");t&&(t.src="")}let J=null,q=null;function te(e){const t=document.createElement("div");t.classList.add("table-scroll");const i=document.createElement("table");i.classList.add("tabseance__commande-table");const r=document.createElement("thead"),l=document.createElement("tr");["Jour","Cin\xE9ma","Horaire","Qualit\xE9","Tarifs"].forEach(a=>{const o=document.createElement("th");o.textContent=a,l.appendChild(o)}),r.appendChild(l),i.appendChild(r);const n=document.createElement("tbody");i.appendChild(n);let s=c.seancesFilm(e.id);const u=new Date,m=new Date;return s=s.filter(a=>{var o;if(a.numFreeSeats==="0")return!1;if(a.dateJour){const d=new Date(a.dateJour);if(d.getFullYear()===m.getFullYear()&&d.getMonth()===m.getMonth()&&d.getDate()===m.getDate()){const[p,v]=((o=a.hourBeginHHSMM)!==null&&o!==void 0?o:"00:00").split(":").map(Number),f=new Date(d);f.setHours(p,v,0,0);const h=new Date(u);if(h.setHours(h.getHours()+1),f<h)return!1}}return!0}),s.sort((a,o)=>{var d,p,v,f;return a.dateJour===o.dateJour?((d=a.hourBeginHHSMM)!==null&&d!==void 0?d:"").localeCompare((p=o.hourBeginHHSMM)!==null&&p!==void 0?p:""):((v=a.dateJour)!==null&&v!==void 0?v:"").localeCompare((f=o.dateJour)!==null&&f!==void 0?f:"")}),s.forEach(a=>{const o=document.createElement("tr"),d=b(new Date(a.dateJour||"")),p=a.nameCinema||"",v=`${a.hourBeginHHSMM||""} - ${a.hourEndHHSMM||""}`,f=a.qualite||"",h=c.allTarifQualite.filter(y=>y.qualite===f).map(y=>`${y.nameTarif} (${y.price}\u20AC)`).join(", "),w=a.seanceId,g=document.createElement("td");g.textContent=d;const S=document.createElement("td");S.textContent=p;const D=document.createElement("td");D.textContent=v;const C=document.createElement("td");C.textContent=f;const E=document.createElement("td");E.textContent=h,o.append(g,S,D,C,E),o.addEventListener("click",()=>{q&&q!==o&&q.classList.remove("selected-row"),o.classList.add("selected-row"),q=o,J={Jour:d,Cinema:p,Horaire:v,Qualite:f,Tarifs:h,SeanceId:w};const y=document.querySelector(".right__jereserve-button");y&&(y.disabled=!1)}),n.appendChild(o)}),t.appendChild(i),t}function ne(e){const t=document.getElementById("openModal"),i=document.getElementById("videoModal"),r=i?.querySelector(".closeyoutube"),l=document.getElementById("youtubeVideo"),n=`${e}?autoplay=1`;if(console.log("URL dynamique = ",n),t&&i&&r&&l&&n){t.addEventListener("click",()=>{i.style.display="flex",l.src=n,console.log("URL utilis\xE9e = ",l.src)});const s=()=>{i.style.display="none",l.src=""};r.addEventListener("click",s),i.addEventListener("click",u=>{u.target===i&&s()})}else console.error("Un ou plusieurs \xE9l\xE9ments requis pour le fonctionnement de la modal sont introuvables.")}
